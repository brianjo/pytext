
<script type="text/javascript" id="documentation_options" data-url_root="./"
  src="/js/documentation_options.js"></script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/doctools.js"></script>
<script type="text/javascript" src="/js/language_data.js"></script>
<script type="text/javascript" src="/js/searchtools.js"></script>
<div class="sphinx"><div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<div class="section" id="execute-your-first-model">
<h1>Execute your first model<a class="headerlink" href="#execute-your-first-model" title="Permalink to this headline">¶</a></h1>
<p>In <a class="reference internal" href="train_your_first_model.html"><span class="doc">Train your first model</span></a>, we learnt how to train a small, simple model. We can continue this tutorial with that model here. This procedure can be used for any pytext model by supplying the matching config. For example, the much more powerful model from <a class="reference internal" href="atis_tutorial.html"><span class="doc">Train Intent-Slot model on ATIS Dataset</span></a> can be executed using this same procedure.</p>
<div class="section" id="evaluate-the-model">
<h2>Evaluate the model<a class="headerlink" href="#evaluate-the-model" title="Permalink to this headline">¶</a></h2>
<p>We want to run the model on our test dataset and see how well it performs. Some results have been abbreviated for clarity.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">(pytext) $</span> pytext <span class="nb">test</span> &lt; demo/configs/docnn.json

<span class="go">Stage.TEST</span>
<span class="go">loss: 2.059336</span>
<span class="go">Accuracy: 20.00</span>

<span class="go">Macro P/R/F1 Scores:</span>
<span class="go">    Label                       Precision   Recall      F1          Support</span>

<span class="go">    reminder/set_reminder       25.00       100.00      40.00       1</span>
<span class="go">    alarm/time_left_on_alarm    0.00        0.00        0.00        1</span>
<span class="go">    alarm/show_alarms           0.00        0.00        0.00        1</span>
<span class="go">    alarm/set_alarm             0.00        0.00        0.00        2</span>
<span class="go">    Overall macro scores        6.25        25.00       10.00</span>

<span class="go">Soft Metrics:</span>
<span class="go">    Label       Average precision</span>
<span class="go">    alarm/set_alarm 50.00</span>
<span class="go">    alarm/time_left_on_alarm    20.00</span>
<span class="go">    reminder/set_reminder   25.00</span>
<span class="go">    alarm/show_alarms   20.00</span>
<span class="go">    weather/find    nan</span>
<span class="go">    alarm/modify_alarm  nan</span>
<span class="go">    alarm/snooze_alarm  nan</span>
<span class="go">    reminder/show_reminders nan</span>
<span class="go">    Label       Recall at precision 0.2</span>
<span class="go">    alarm/set_alarm 100.00</span>
<span class="go">    Label       Recall at precision 0.4</span>
<span class="go">    alarm/set_alarm 100.00</span>
<span class="go">    Label       Recall at precision 0.6</span>
<span class="go">    alarm/set_alarm 0.00</span>
<span class="go">    Label       Recall at precision 0.8</span>
<span class="go">    alarm/set_alarm 0.00</span>
<span class="go">    Label       Recall at precision 0.9</span>
<span class="go">    alarm/set_alarm 0.00</span>
<span class="go">    Label       Recall at precision 0.2</span>
<span class="go">    alarm/time_left_on_alarm    100.00</span>
<span class="go">    Label       Recall at precision 0.4</span>
<span class="go">    alarm/time_left_on_alarm    0.00</span>
<span class="go">    Label       Recall at precision 0.6</span>
<span class="go">    alarm/time_left_on_alarm    0.00</span>
<span class="go">... [snip]</span>
<span class="go">    reminder/show_reminders 0.00</span>
<span class="go">    Label       Recall at precision 0.6</span>
<span class="go">    reminder/show_reminders 0.00</span>
<span class="go">    Label       Recall at precision 0.8</span>
<span class="go">    reminder/show_reminders 0.00</span>
<span class="go">    Label       Recall at precision 0.9</span>
<span class="go">    reminder/show_reminders 0.00</span>
</pre></div>
</div>
</div>
<div class="section" id="export-the-model">
<h2>Export the model<a class="headerlink" href="#export-the-model" title="Permalink to this headline">¶</a></h2>
<p>When you save a PyTorch model, the snapshot uses <cite>pickle</cite> for serialization. This means that simple code changes (e.g. a word embedding update) can cause backward incompatibilities with your deployed model. To combat this, you can export your model into the <a class="reference external" href="https://caffe2.ai/">Caffe2</a> format using in-built <a class="reference external" href="https://onnx.ai/">ONNX</a> integration. The exported Caffe2 model would have the same behavior regardless of changes in PyText or in your development code.</p>
<p>Exporting a model is pretty simple:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">(pytext) $</span> pytext <span class="nb">export</span> --help
<span class="go">Usage: pytext export [OPTIONS]</span>

<span class="go">  Convert a pytext model snapshot to a caffe2 model.</span>

<span class="go">Options:</span>
<span class="go">  --model TEXT        the pytext snapshot model file to load</span>
<span class="go">  --output-path TEXT  where to save the exported model</span>
<span class="go">  --help              Show this message and exit.</span>
</pre></div>
</div>
<p>You can also pass in a configuration to infer some of these options. In this case let’s do that because depending on how you’re following along your snapshot might be in different places!</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">(pytext) $</span> pytext <span class="nb">export</span> --output-path exported_model.c2 &lt; demo/configs/docnn.json
<span class="go">...[snip]</span>
<span class="go">Saving caffe2 model to: exported_model.c2</span>
</pre></div>
</div>
<p>This file now contains all of the information needed to run your model.</p>
<p>There’s an important distinction between what a model does and what happens before/after the model is called, i.e. the preprocessing and postprocessing steps. PyText strives to do as little preprocessing as possible, but one step that is very often needed is tokenization of the input text. This will happen automatically with our prediction interface, and if this behavior ever changes, we’ll make sure that old models are still supported. The model file you export will always work, and you don’t necessarily need PyText to use it! Depending on your use case you can implement preprocessing yourself and call the model directly, but that’s outside the scope of this tutorial.</p>
</div>
<div class="section" id="make-a-simple-app">
<h2>Make a simple app<a class="headerlink" href="#make-a-simple-app" title="Permalink to this headline">¶</a></h2>
<p>Let’s put this all into practice! How might we make a simple web app that loads an exported model and does something meaningful with it?</p>
<p>To run the following code, you should</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">(pytext) $</span> pip install flask
</pre></div>
</div>
<p>Then we implement a minimal <a class="reference external" href="http://flask.pocoo.org/">Flask</a> web server.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">import</span> <span class="nn">pytext</span>

<span class="n">config_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">model_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">pytext</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">pytext</span><span class="o">.</span><span class="n">create_predictor</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model_file</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">'/get_flight_info'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_flight_info</span><span class="p">():</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="c1"># Pass the inputs to PyText's prediction API</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">({</span><span class="s2">"text"</span><span class="p">:</span> <span class="n">text</span><span class="p">})</span>

    <span class="c1"># Results is a list of output blob names and their scores.</span>
    <span class="c1"># The blob names are different for joint models vs doc models</span>
    <span class="c1"># Since this tutorial is for both, let's check which one we should look at.</span>
    <span class="n">doc_label_scores_prefix</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">'scores:'</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'scores:'</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">else</span> <span class="s1">'doc_scores:'</span>
    <span class="p">)</span>

    <span class="c1"># For now let's just output the top document label!</span>
    <span class="n">best_doc_label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="p">(</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">doc_label_scores_prefix</span><span class="p">)),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">label</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="c1"># Strip the doc label prefix here</span>
    <span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">doc_label_scores_prefix</span><span class="p">):]</span>

    <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">jsonify</span><span class="p">({</span><span class="s2">"question"</span><span class="p">:</span> <span class="n">f</span><span class="s2">"Are you asking about {best_doc_label}?"</span><span class="p">})</span>

<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s1">'8080'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute the app</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">(pytext) $</span> python flask_app.py demo/configs/docnn.json exported_model.c2
<span class="go">* Serving Flask app "flask_app" (lazy loading)</span>
<span class="go">* Environment: production</span>
<span class="go">  WARNING: Do not use the development server in a production environment.</span>
<span class="go">  Use a production WSGI server instead.</span>
<span class="go">* Debug mode: on</span>
</pre></div>
</div>
<p>Then in a separate terminal window</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="k">function</span> ask_about<span class="o">()</span> <span class="o">{</span> curl http://localhost:8080/get_flight_info -H <span class="s2">"Content-Type: text/plain"</span> -d <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">}</span>

<span class="gp">$</span> ask_about <span class="s1">'I am looking for flights from San Francisco to Minneapolis'</span>
<span class="go">{</span>
<span class="go">  "question": "Are you asking about flight?"</span>
<span class="go">}</span>

<span class="gp">$</span> ask_about <span class="s1">'How much does a trip to NY cost?'</span>
<span class="go">{</span>
<span class="go">  "question": "Are you asking about airfare?"</span>
<span class="go">}</span>

<span class="gp">$</span> ask_about <span class="s2">"Which airport should I go to?"</span>
<span class="go">{</span>
<span class="go">  "question": "Are you asking about airport?"</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PyText</a></h1>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="train_your_first_model.html">Train your first model</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Execute your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualize_your_model.html">Visualize Model Training with TensorBoard</a></li>
<li class="toctree-l1"><a class="reference internal" href="pytext_models_in_your_app.html">Use PyText models in your app</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving_models_in_production.html">Serve Models in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_files.html">Config Files Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_commands.html">Config Commands</a></li>
</ul>
<p class="caption"><span class="caption-text">Training More Advanced Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="atis_tutorial.html">Train Intent-Slot model on ATIS Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="hierarchical_intent_slot_tutorial.html">Hierarchical intent and slot filling</a></li>
<li class="toctree-l1"><a class="reference internal" href="disjoint_multitask_tutorial.html">Multitask training with disjoint datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorial.html">Data Parallel Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="xlm_r.html">XLM-RoBERTa</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending PyText</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="datasource_tutorial.html">Custom Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="tensorizer.html">Custom Tensorizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="dense.html">Using External Dense Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_new_model.html">Creating A New Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacking_pytext.html">Hacking PyText</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="configs/pytext.html">pytext</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/pytext.html">pytext package</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="index.html">Documentation overview</a><ul>
<li>Previous: <a href="train_your_first_model.html" title="previous chapter">Train your first model</a></li>
<li>Next: <a href="visualize_your_model.html" title="next chapter">Visualize Model Training with TensorBoard</a></li>
</ul></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="search.html" class="search" method="get">
<input aria-labelledby="searchlabel" name="q" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div></div>
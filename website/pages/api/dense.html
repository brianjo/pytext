
<script type="text/javascript" id="documentation_options" data-url_root="./"
  src="/js/documentation_options.js"></script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/doctools.js"></script>
<script type="text/javascript" src="/js/language_data.js"></script>
<script type="text/javascript" src="/js/searchtools.js"></script>
<div class="sphinx"><div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<div class="section" id="using-external-dense-features">
<h1>Using External Dense Features<a class="headerlink" href="#using-external-dense-features" title="Permalink to this headline">¶</a></h1>
<p>Sometime you want to add external features to augment the inputs to your model. For example, if you want to classify a text that has an image associated to it, you might want to process the image separately and use features of this image along with the text to help the classifier. Those features are added in the input data as one extra field (column) and should look like a list of floats (json).</p>
<p>Let’s look at a simple example, first without the dense feature, then we add dense features.</p>
<div class="section" id="example-simple-model">
<h2>Example: Simple Model<a class="headerlink" href="#example-simple-model" title="Permalink to this headline">¶</a></h2>
<p>First, here’s an example of a simple classifier that uses just the text and no dense features. (This is only showing the relevant parts of the model code for simplicity.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
  <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">ModelInput</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">InputConfig</span><span class="p">):</span>
      <span class="n">tokens</span><span class="p">:</span> <span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
      <span class="n">labels</span><span class="p">:</span> <span class="n">LabelTensorizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">LabelTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

    <span class="n">inputs</span><span class="p">:</span> <span class="n">ModelInput</span> <span class="o">=</span> <span class="n">ModelInput</span><span class="p">()</span>
    <span class="n">token_embedding</span><span class="p">:</span> <span class="n">WordEmbedding</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">WordEmbedding</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

    <span class="n">representation</span><span class="p">:</span> <span class="n">RepresentationBase</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">DocNNRepresentation</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
    <span class="n">decoder</span><span class="p">:</span> <span class="n">DecoderBase</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">MLPDecoder</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
    <span class="n">output_layer</span><span class="p">:</span> <span class="n">OutputLayerBase</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">ClassificationOutputLayer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tensorizers</span><span class="p">):</span>
    <span class="n">token_embedding</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">token_embedding</span><span class="p">,</span> <span class="n">tensorizer</span><span class="o">=</span><span class="n">tensorizers</span><span class="p">[</span><span class="s2">"tokens"</span><span class="p">])</span>
    <span class="n">representation</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">representation</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="n">token_embedding</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">tensorizers</span><span class="p">[</span><span class="s2">"labels"</span><span class="p">]</span><span class="o">.</span><span class="n">vocab</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span>
        <span class="n">in_dim</span><span class="o">=</span><span class="n">representation</span><span class="o">.</span><span class="n">representation_dim</span>
        <span class="n">out_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">token_embedding</span><span class="p">,</span> <span class="n">representation</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">output_layer</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">arrange_model_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_dict</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tensor_dict</span><span class="p">[</span><span class="s2">"tokens"</span><span class="p">],)</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">tokens_in</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">word_tokens</span><span class="p">,</span> <span class="n">seq_lens</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">embedding_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">word_tokens</span><span class="p">)</span>
        <span class="n">representation_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">representation</span><span class="p">(</span><span class="n">embedding_out</span><span class="p">,</span> <span class="n">seq_lens</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">representation_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="example-simple-model-with-dense-features">
<h2>Example: Simple Model With Dense Features<a class="headerlink" href="#example-simple-model-with-dense-features" title="Permalink to this headline">¶</a></h2>
<p>To use the dense features, you will typically write your model to use them directly in the decoder, bypassing the embeddings and representation stages that process the text part of your inputs. Here’s the same example again, this time with the dense features added (see lines marked with &lt;–).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
  <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">ModelInput</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">InputConfig</span><span class="p">):</span>
      <span class="n">tokens</span><span class="p">:</span> <span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
      <span class="n">dense</span><span class="p">:</span> <span class="n">FloatListTensorizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">FloatListTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>  <span class="c1"># &lt;--</span>
      <span class="n">labels</span><span class="p">:</span> <span class="n">LabelTensorizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">LabelTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

    <span class="n">inputs</span><span class="p">:</span> <span class="n">ModelInput</span> <span class="o">=</span> <span class="n">ModelInput</span><span class="p">()</span>
    <span class="n">token_embedding</span><span class="p">:</span> <span class="n">WordEmbedding</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">WordEmbedding</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

    <span class="n">representation</span><span class="p">:</span> <span class="n">RepresentationBase</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">DocNNRepresentation</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
    <span class="n">decoder</span><span class="p">:</span> <span class="n">DecoderBase</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">MLPDecoder</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
    <span class="n">output_layer</span><span class="p">:</span> <span class="n">OutputLayerBase</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">ClassificationOutputLayer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">tensorizers</span><span class="p">):</span>
    <span class="n">token_embedding</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">token_embedding</span><span class="p">,</span> <span class="n">tensorizer</span><span class="o">=</span><span class="n">tensorizers</span><span class="p">[</span><span class="s2">"tokens"</span><span class="p">])</span>
    <span class="n">representation</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">representation</span><span class="p">,</span> <span class="n">embed_dim</span><span class="o">=</span><span class="n">token_embedding</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>
    <span class="n">dense_dim</span> <span class="o">=</span> <span class="n">tensorizers</span><span class="p">[</span><span class="s2">"dense"</span><span class="p">]</span><span class="o">.</span><span class="n">out_dim</span>    <span class="c1"># &lt;--</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">tensorizers</span><span class="p">[</span><span class="s2">"labels"</span><span class="p">]</span><span class="o">.</span><span class="n">vocab</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">decoder</span><span class="p">,</span>
        <span class="n">in_dim</span><span class="o">=</span><span class="n">representation</span><span class="o">.</span><span class="n">representation_dim</span> <span class="o">+</span> <span class="n">dense_dim</span>    <span class="c1"># &lt;--</span>
        <span class="n">out_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">output_layer</span> <span class="o">=</span> <span class="n">create_module</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">output_layer</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">token_embedding</span><span class="p">,</span> <span class="n">representation</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">output_layer</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">arrange_model_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_dict</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tensor_dict</span><span class="p">[</span><span class="s2">"tokens"</span><span class="p">],</span> <span class="n">tensor_dict</span><span class="p">[</span><span class="s2">"dense"</span><span class="p">])</span>  <span class="c1"># &lt;--</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">tokens_in</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
      <span class="n">dense_in</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>    <span class="c1"># &lt;--</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">word_tokens</span><span class="p">,</span> <span class="n">seq_lens</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">embedding_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">word_tokens</span><span class="p">)</span>
        <span class="n">representation_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">representation</span><span class="p">(</span><span class="n">embedding_out</span><span class="p">,</span> <span class="n">seq_lens</span><span class="p">)</span>
        <span class="n">representation_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">representation_out</span><span class="p">,</span> <span class="n">dense_in</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>    <span class="c1"># &lt;--</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">representation_out</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PyText</a></h1>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="train_your_first_model.html">Train your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="execute_your_first_model.html">Execute your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualize_your_model.html">Visualize Model Training with TensorBoard</a></li>
<li class="toctree-l1"><a class="reference internal" href="pytext_models_in_your_app.html">Use PyText models in your app</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving_models_in_production.html">Serve Models in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_files.html">Config Files Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="config_commands.html">Config Commands</a></li>
</ul>
<p class="caption"><span class="caption-text">Training More Advanced Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="atis_tutorial.html">Train Intent-Slot model on ATIS Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="hierarchical_intent_slot_tutorial.html">Hierarchical intent and slot filling</a></li>
<li class="toctree-l1"><a class="reference internal" href="disjoint_multitask_tutorial.html">Multitask training with disjoint datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed_training_tutorial.html">Data Parallel Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="xlm_r.html">XLM-RoBERTa</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending PyText</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="datasource_tutorial.html">Custom Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="tensorizer.html">Custom Tensorizer</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using External Dense Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="create_new_model.html">Creating A New Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacking_pytext.html">Hacking PyText</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="configs/pytext.html">pytext</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules/pytext.html">pytext package</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="index.html">Documentation overview</a><ul>
<li>Previous: <a href="tensorizer.html" title="previous chapter">Custom Tensorizer</a></li>
<li>Next: <a href="create_new_model.html" title="next chapter">Creating A New Model</a></li>
</ul></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="search.html" class="search" method="get">
<input aria-labelledby="searchlabel" name="q" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div></div>
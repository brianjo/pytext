
<script type="text/javascript" id="documentation_options" data-url_root="./"
  src="/js/documentation_options.js"></script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/doctools.js"></script>
<script type="text/javascript" src="/js/language_data.js"></script>
<script type="text/javascript" src="/js/searchtools.js"></script>
<div class="sphinx"><div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for pytext.config.config_adapter</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved</span>
<span class="kn">from</span> <span class="nn">pytext.common.utils</span> <span class="kn">import</span> <span class="n">eprint</span>

<span class="kn">from</span> <span class="nn">.pytext_config</span> <span class="kn">import</span> <span class="n">LATEST_VERSION</span>


<span class="n">ADAPTERS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">NOT_THERE</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<div class="viewcode-block" id="register_adapter"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.register_adapter">[docs]</a><span class="k">def</span> <span class="nf">register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">from_version</span> <span class="ow">in</span> <span class="n">ADAPTERS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">"Duplicated adapter from_version={}: '{}' and '{}'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">from_version</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">ADAPTERS</span><span class="p">[</span><span class="n">from_version</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ADAPTERS</span><span class="p">[</span><span class="n">from_version</span><span class="p">]</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="find_dicts_containing_key"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.find_dicts_containing_key">[docs]</a><span class="k">def</span> <span class="nf">find_dicts_containing_key</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">json_config</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">json_config</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">json_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">"__contains__"</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">"items"</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>


<div class="viewcode-block" id="rename"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.rename">[docs]</a><span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="n">old_name</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_name</span><span class="p">:</span>
            <span class="n">section</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="is_type_specifier"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.is_type_specifier">[docs]</a><span class="k">def</span> <span class="nf">is_type_specifier</span><span class="p">(</span><span class="n">json_dict</span><span class="p">):</span>
    <span class="sd">"""If a config object is a class, it might have a level which is a type specifier,</span>
<span class="sd">    with one key corresponding to the name of whichever type it is. These types should</span>
<span class="sd">    not be explicitly named in the path."""</span>
    <span class="c1"># heuristic: one key, starting with uppercase character</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">json_dict</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span></div>


<div class="viewcode-block" id="find_parameter"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.find_parameter">[docs]</a><span class="k">def</span> <span class="nf">find_parameter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path_str</span><span class="p">):</span>
    <span class="c1"># Recursively find path elements, skipping into type specifiers.</span>
    <span class="c1"># Return the value and its container so the value can be deleted.</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">path_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">config</span>
    <span class="n">container</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">is_type_specifier</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">container</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">segment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">NOT_THERE</span>
        <span class="n">container</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">container</span><span class="p">,</span> <span class="n">value</span></div>


<span class="k">def</span> <span class="nf">_create_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="c1"># Recursively find path elements, skipping into type specifiers.</span>
    <span class="c1"># If any container isn't there, create a new empty object for it.</span>
    <span class="c1"># This will only be created if the</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">config</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">is_type_specifier</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">segment</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">is_type_specifier</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">value</span>


<div class="viewcode-block" id="create_parameter"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.create_parameter">[docs]</a><span class="k">def</span> <span class="nf">create_parameter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path_str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">param</span> <span class="o">=</span> <span class="n">path_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"."</span><span class="p">)</span>
    <span class="n">new_container</span> <span class="o">=</span> <span class="n">_create_path</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">new_container</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="delete_parameter"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.delete_parameter">[docs]</a><span class="k">def</span> <span class="nf">delete_parameter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path_str</span><span class="p">):</span>
    <span class="n">param_name</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_parameter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">container</span><span class="p">:</span>
        <span class="n">container</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="rename_parameter"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.rename_parameter">[docs]</a><span class="k">def</span> <span class="nf">rename_parameter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">old_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">"""A powerful tool for writing config adapters, this allows you to specify</span>
<span class="sd">    a JSON-style path for an old and new config parameter. For instance</span>

<span class="sd">    rename_parameter(config, "task.data.epoch_size", "task.trainer.batches_per_epoch")</span>

<span class="sd">    will look through the config for task.data.epoch_size, including moving through</span>
<span class="sd">    explicitly specified types. If it's specified, it will delete the value and</span>
<span class="sd">    set it in task.trainer.num_batches_per_epoch instead, creating trainer as an empty</span>
<span class="sd">    dictionary if necessary."""</span>

    <span class="n">found</span> <span class="o">=</span> <span class="n">find_parameter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">old_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOT_THERE</span><span class="p">:</span>
        <span class="n">param_name</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">old_value</span> <span class="o">=</span> <span class="n">found</span>
        <span class="c1"># Delete old value</span>
        <span class="n">container</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
        <span class="c1"># Update new value</span>
        <span class="n">create_parameter</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="n">transform</span><span class="p">(</span><span class="n">old_value</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">config</span></div>


<div class="viewcode-block" id="v0_to_v1"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.v0_to_v1">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">v0_to_v1</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="c1"># migrate optimizer and random_seed params</span>
    <span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">"optimizer"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span>
        <span class="ow">or</span> <span class="s2">"Adam"</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]</span>
        <span class="ow">or</span> <span class="s2">"SGD"</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]</span>
        <span class="ow">or</span> <span class="s2">"NAG"</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]</span>
    <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">"trainer"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span> <span class="ow">or</span> <span class="s2">"random_seed"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"trainer"</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">json_config</span>

    <span class="k">if</span> <span class="s2">"trainer"</span> <span class="ow">in</span> <span class="n">task</span> <span class="ow">and</span> <span class="s2">"random_seed"</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"trainer"</span><span class="p">]:</span>
        <span class="n">json_config</span><span class="p">[</span><span class="s2">"random_seed"</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"trainer"</span><span class="p">][</span><span class="s2">"random_seed"</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">task</span><span class="p">[</span><span class="s2">"trainer"</span><span class="p">][</span><span class="s2">"random_seed"</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">"optimizer"</span> <span class="ow">in</span> <span class="n">task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">opt</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"Adam"</span><span class="p">,</span> <span class="s2">"SGD"</span><span class="p">,</span> <span class="s2">"NAG"</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">op_type</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"type"</span><span class="p">,</span> <span class="s2">"adam"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"adam"</span><span class="p">:</span>
            <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"Adam"</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"lr"</span><span class="p">,</span> <span class="s2">"weight_decay"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]:</span>
                    <span class="n">op_config</span><span class="p">[</span><span class="s2">"Adam"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"sgd"</span><span class="p">:</span>
            <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"SGD"</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"lr"</span><span class="p">,</span> <span class="s2">"momentum"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]:</span>
                    <span class="n">op_config</span><span class="p">[</span><span class="s2">"SGD"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"nag"</span><span class="p">:</span>
            <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"NAG"</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"lr"</span><span class="p">,</span> <span class="s2">"weight_decay"</span><span class="p">,</span> <span class="s2">"momentum"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]:</span>
                    <span class="n">op_config</span><span class="p">[</span><span class="s2">"NAG"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Migration not supported for your optimizer"</span><span class="p">)</span>
        <span class="n">task</span><span class="p">[</span><span class="s2">"optimizer"</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_config</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="v1_to_v2"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.v1_to_v2">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">v1_to_v2</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="c1"># migrate optimizer params</span>
    <span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">"scheduler"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span>
        <span class="ow">or</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="ow">or</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"type"</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">json_config</span>
    <span class="n">op_type</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"type"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"step_lr"</span><span class="p">:</span>
        <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"StepLR"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"step_size"</span><span class="p">,</span> <span class="s2">"gamma"</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]:</span>
                <span class="n">op_config</span><span class="p">[</span><span class="s2">"StepLR"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_config</span>
    <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"lm_fine_tuning"</span><span class="p">:</span>
        <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"LmFineTuning"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">"cut_frac"</span><span class="p">,</span>
            <span class="s2">"ratio"</span><span class="p">,</span>
            <span class="s2">"non_pretrained_param_groups"</span><span class="p">,</span>
            <span class="s2">"lm_lr_multiplier"</span><span class="p">,</span>
            <span class="s2">"lm_use_per_layer_lr"</span><span class="p">,</span>
            <span class="s2">"lm_gradual_unfreezing"</span><span class="p">,</span>
            <span class="s2">"last_epoch"</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]:</span>
                <span class="n">op_config</span><span class="p">[</span><span class="s2">"LmFineTuning"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_config</span>
    <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"reduce_lr_on_plateau"</span><span class="p">:</span>
        <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"ReduceLROnPlateau"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">"lower_is_better"</span><span class="p">,</span>
            <span class="s2">"factor"</span><span class="p">,</span>
            <span class="s2">"patience"</span><span class="p">,</span>
            <span class="s2">"min_lr"</span><span class="p">,</span>
            <span class="s2">"threshold"</span><span class="p">,</span>
            <span class="s2">"threshold_is_absolute"</span><span class="p">,</span>
            <span class="s2">"cooldown"</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]:</span>
                <span class="n">op_config</span><span class="p">[</span><span class="s2">"ReduceLROnPlateau"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_config</span>
    <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"cosine_annealing_lr"</span><span class="p">:</span>
        <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"CosineAnnealingLR"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"t_max"</span><span class="p">,</span> <span class="s2">"eta_min"</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]:</span>
                <span class="n">op_config</span><span class="p">[</span><span class="s2">"CosineAnnealingLR"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_config</span>
    <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"exponential_lr"</span><span class="p">:</span>
        <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"ExponentialLR"</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"gamma"</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]:</span>
                <span class="n">op_config</span><span class="p">[</span><span class="s2">"ExponentialLR"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_config</span>
    <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">"none"</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">task</span><span class="p">[</span><span class="s2">"scheduler"</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Migration for your scheduler </span><span class="si">%s</span><span class="s2"> not supported."</span> <span class="o">%</span> <span class="n">op_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="v2_to_v3"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.v2_to_v3">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">v2_to_v3</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""Optimizer and Scheduler configs used to be part of the task config,</span>
<span class="sd">    they now live in the trainer's config.</span>
<span class="sd">    """</span>
    <span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">section_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"optimizer"</span><span class="p">,</span> <span class="s2">"scheduler"</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">section_str</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"trainer"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
                <span class="n">task</span><span class="p">[</span><span class="s2">"trainer"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">"trainer"</span><span class="p">]</span>
            <span class="c1"># a hack to support an older hack:</span>
            <span class="c1"># some tasks like ensemble have a 'real_trainer' section inside trainer</span>
            <span class="c1"># that has the actual trainer config</span>
            <span class="k">if</span> <span class="s2">"real_trainer"</span> <span class="ow">in</span> <span class="n">trainer</span><span class="p">:</span>
                <span class="n">real_trainer</span> <span class="o">=</span> <span class="n">trainer</span><span class="p">[</span><span class="s2">"real_trainer"</span><span class="p">]</span>
                <span class="n">real_trainer</span><span class="p">[</span><span class="n">section_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">section_str</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trainer</span><span class="p">[</span><span class="n">section_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">section_str</span><span class="p">]</span>
            <span class="c1"># remove from task config</span>
            <span class="n">task</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">section_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="v3_to_v4"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.v3_to_v4">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">v3_to_v4</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""Key for provding the path for contextual token embedding has changed from</span>
<span class="sd">    `pretrained_model_embedding` to `contextual_token_embedding. This affects the</span>
<span class="sd">    `features` section of the config.</span>
<span class="sd">    """</span>
    <span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">old_key</span> <span class="o">=</span> <span class="s2">"pretrained_model_embedding"</span>
    <span class="n">new_key</span> <span class="o">=</span> <span class="s2">"contextual_token_embedding"</span>
    <span class="k">for</span> <span class="n">section_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"features"</span><span class="p">,</span> <span class="s2">"labels"</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">section_str</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="n">section_str</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">section</span> <span class="ow">and</span> <span class="n">old_key</span> <span class="ow">in</span> <span class="n">section</span><span class="p">:</span>
                <span class="n">section</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span><span class="p">[</span><span class="n">old_key</span><span class="p">]</span>
                <span class="n">section</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_key</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="deprecate"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.deprecate">[docs]</a><span class="k">def</span> <span class="nf">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">section</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="s2">"_Deprecated"</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">t</span><span class="p">)</span></div>


<div class="viewcode-block" id="doc_model_deprecated"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.doc_model_deprecated">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">doc_model_deprecated</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""Rename DocModel to DocModel_Deprecated."""</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"DocModel"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="old_tasks_deprecated"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.old_tasks_deprecated">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">old_tasks_deprecated</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Rename tasks with data_handler config to _Deprecated</span>
<span class="sd">    """</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"BertClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"BertPairClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"BertPairwiseClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"COLMClassifyTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"ContextSCLSTMCompositionalTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"ContextSeq2SeqTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"DocClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"ElmoDocClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"ElmoFineTunePairwiseClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"EnsembleTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"FederatedLearningTaskBase"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"FLDocClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"FLQueryDocumentPairwiseRankingTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"KDDocClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"LMTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"PairClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"PairwiseAttentionClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"QueryDocumentPairwiseRankingTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"SCLSTMCompositionalTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"SCLSTMTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"SemanticParsingCppTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"SemanticParsingTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"Seq2SeqTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"Seq2SeqCompositionalMetricReporter"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"Seq2SeqMetricReporter"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"RNNEncoderDecoder"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"SeqNNTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"SGNNClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"ShallowClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"ShallowTaggingTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"SpanClassificationTask"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"TreeParserTask"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="v6_to_v7"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.v6_to_v7">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">v6_to_v7</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make `LabelTensorizer` expansible. If the `labels` field should be an instance of</span>
<span class="sd">    `LabelTensorizer`, convert it to`{LabelTensorizer: labels}`.</span>
<span class="sd">    """</span>
    <span class="p">[(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">task</span><span class="p">)]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">task_name</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">"BertPairRegressionTask"</span><span class="p">,</span>
        <span class="s2">"NewDocumentRegression"</span><span class="p">,</span>
        <span class="s2">"NewWordTaggingTask"</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Task has a label tensorizer different from LabelTensorizer.</span>
        <span class="k">return</span> <span class="n">json_config</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json_config</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s2">"inputs"</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">"inputs"</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="p">[(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_val</span><span class="p">)]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">model_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"inputs"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json_config</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">"NewBertRegressionModel"</span><span class="p">,</span>
        <span class="s2">"DocRegressionModel"</span><span class="p">,</span>
        <span class="s2">"NewWordTaggingModel"</span><span class="p">,</span>
        <span class="s2">"ELModel"</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Model has a label tensorizer different from LabelTensorizer.</span>
        <span class="k">return</span> <span class="n">json_config</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"labels"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json_config</span>

    <span class="n">inputs</span><span class="p">[</span><span class="s2">"labels"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"LabelTensorizer"</span><span class="p">:</span> <span class="n">labels</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="lm_model_deprecated"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.lm_model_deprecated">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lm_model_deprecated</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Rename LM model to _Deprecated (LMTask is already deprecated in v5)</span>
<span class="sd">    """</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"LMLSTM"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="new_tasks_rename"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.new_tasks_rename">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">new_tasks_rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Rename tasks with new API consistently</span>
<span class="sd">    """</span>
    <span class="c1"># Deprecated</span>
    <span class="n">rename</span><span class="p">(</span>
        <span class="n">json_config</span><span class="p">,</span>
        <span class="s2">"QueryDocumentPairwiseRankingModel"</span><span class="p">,</span>
        <span class="s2">"QueryDocumentPairwiseRankingModel_Deprecated"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># New</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"NewDocModel"</span><span class="p">,</span> <span class="s2">"DocModel"</span><span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"NewDocRegressionModel"</span><span class="p">,</span> <span class="s2">"DocRegressionModel"</span><span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"NewDocumentClassification"</span><span class="p">,</span> <span class="s2">"DocumentClassificationTask"</span><span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"NewDocumentRegression"</span><span class="p">,</span> <span class="s2">"DocumentRegressionTask"</span><span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span>
        <span class="n">json_config</span><span class="p">,</span>
        <span class="s2">"NewQueryDocumentPairwiseRankingModel"</span><span class="p">,</span>
        <span class="s2">"QueryDocPairwiseRankingModel"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"NewWordTaggingModel"</span><span class="p">,</span> <span class="s2">"WordTaggingModel"</span><span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"NewWordTaggingTask"</span><span class="p">,</span> <span class="s2">"WordTaggingTask"</span><span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"PairwiseClassification"</span><span class="p">,</span> <span class="s2">"PairwiseClassificationTask"</span><span class="p">)</span>
    <span class="n">rename</span><span class="p">(</span>
        <span class="n">json_config</span><span class="p">,</span> <span class="s2">"QueryDocumentPairwiseRanking"</span><span class="p">,</span> <span class="s2">"QueryDocumentPairwiseRankingTask"</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="move_epoch_size"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.move_epoch_size">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">move_epoch_size</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">json_config</span><span class="p">,</span> <span class="s2">"task.data.epoch_size"</span><span class="p">,</span> <span class="s2">"task.trainer.num_batches_per_epoch"</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="ensemble_task_deprecated"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.ensemble_task_deprecated">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ensemble_task_deprecated</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Rename tasks with new API consistently</span>
<span class="sd">    """</span>
    <span class="c1"># Deprecated</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"BaggingDocEnsemble"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"BaggingIntentSlotEnsemble"</span><span class="p">)</span>
    <span class="n">deprecate</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"EnsembleTrainer"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="rename_bitransformer_inputs"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.rename_bitransformer_inputs">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rename_bitransformer_inputs</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    In "BiTransformer" model, rename input "characters" -&gt; "bytes" and update subfields.</span>
<span class="sd">    """</span>
    <span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">"BiTransformer"</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">model_val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">"inputs"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_val</span><span class="p">:</span>
            <span class="n">model_val</span><span class="p">[</span><span class="s2">"inputs"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">model_val</span><span class="p">[</span><span class="s2">"inputs"</span><span class="p">]</span>
        <span class="n">char_config</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"characters"</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="s2">"max_char_length"</span> <span class="ow">in</span> <span class="n">char_config</span><span class="p">:</span>
            <span class="n">char_config</span><span class="p">[</span><span class="s2">"max_byte_len"</span><span class="p">]</span> <span class="o">=</span> <span class="n">char_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"max_char_length"</span><span class="p">)</span>
        <span class="n">char_config</span><span class="p">[</span><span class="s2">"offset_for_non_padding"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">model_val</span><span class="p">[</span><span class="s2">"inputs"</span><span class="p">][</span><span class="s2">"bytes"</span><span class="p">]</span> <span class="o">=</span> <span class="n">char_config</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="v12_to_v13"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.v12_to_v13">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">v12_to_v13</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""remove_output_encoded_layers(json_config)"""</span>
    <span class="n">rename</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"output_encoded_layers"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="sd">"""</span>
<span class="sd">    Make 'ClassificationMetricReporter'</span>
<span class="sd">    expansible.</span>

<span class="sd">    If the 'metric_reporter' field should be an instance of</span>
<span class="sd">    'ClassificationMetricReporter',</span>
<span class="sd">    convert it to '{ClassificationMetricReporter: metric_reporter}'.</span>
<span class="sd">    """</span>

    <span class="p">[(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">task</span><span class="p">)]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">task_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">"EnsembleTask"</span><span class="p">,</span>
        <span class="s2">"DocClassificationTask_Deprecated"</span><span class="p">,</span>
        <span class="s2">"DocumentClassificationTask"</span><span class="p">,</span>
        <span class="s2">"PairwiseClassificationTask"</span><span class="p">,</span>
        <span class="s2">"SeqNNTask"</span><span class="p">,</span>
        <span class="s2">"ShallowClassificationTask_Deprecated"</span><span class="p">,</span>
        <span class="s2">"KDDocClassificationTask_Deprecated"</span><span class="p">,</span>
        <span class="s2">"PairwiseAttentionClassificationTask_Deprecated"</span><span class="p">,</span>
        <span class="s2">"ElmoFineTunePairwiseClassificationTask_Deprecated"</span><span class="p">,</span>
        <span class="s2">"XLMDocumentClassification"</span><span class="p">,</span>
        <span class="s2">"XLMPairClassification"</span><span class="p">,</span>
        <span class="s2">"NewBertClassificationTask"</span><span class="p">,</span>
        <span class="s2">"NewBertPairClassificationTask"</span><span class="p">,</span>
        <span class="s2">"LaserClassificationTask"</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Task has a metric reporter different from ClassificationMetricReporter</span>
        <span class="k">return</span> <span class="n">json_config</span>
    <span class="n">metric_reporter</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"metric_reporter"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric_reporter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json_config</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metric_reporter</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">return</span> <span class="n">json_config</span>
    <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"output_path"</span><span class="p">,</span> <span class="s2">"model_select_metric"</span><span class="p">,</span> <span class="s2">"target_label"</span><span class="p">,</span> <span class="s2">"text_column_names"</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">:</span>
        <span class="n">task</span><span class="p">[</span><span class="s2">"metric_reporter"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"ClassificationMetricReporter"</span><span class="p">:</span> <span class="n">metric_reporter</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json_config</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="rename_tensorizer_vocab_params"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.rename_tensorizer_vocab_params">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rename_tensorizer_vocab_params</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="p">[(</span><span class="n">task_name</span><span class="p">,</span> <span class="n">task</span><span class="p">)]</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"task"</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="c1"># XLM and Bert models use the `vocab_file` field, but in a custom way. This</span>
    <span class="c1"># field should not be migrated to `vocab.vocab_files` as for TokenTensorizer.</span>
    <span class="k">if</span> <span class="s2">"XLM"</span> <span class="ow">in</span> <span class="n">task_name</span> <span class="ow">or</span> <span class="s2">"Bert"</span> <span class="ow">in</span> <span class="n">task_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json_config</span>

    <span class="k">def</span> <span class="nf">resolve_model</span><span class="p">(</span><span class="n">model_config</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_config</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="p">[(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)]</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">"XLM"</span> <span class="ow">in</span> <span class="n">model_name</span> <span class="ow">or</span> <span class="s2">"Bert"</span> <span class="ow">in</span> <span class="n">model_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">model_config</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">resolve_model</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"model"</span><span class="p">,</span> <span class="p">{}))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json_config</span>

    <span class="k">def</span> <span class="nf">update_model_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">):</span>
        <span class="n">model_config</span> <span class="o">=</span> <span class="n">resolve_model</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"inputs"</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tokens"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">vocab</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"build_from_data"</span><span class="p">:</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"build_vocab"</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="s2">"vocab_files"</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">if</span> <span class="s2">"vocab_file"</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">vocab</span><span class="p">[</span><span class="s2">"vocab_files"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">"filepath"</span><span class="p">:</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"vocab_file"</span><span class="p">),</span>
                    <span class="s2">"size_limit"</span><span class="p">:</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"vocab_file_size_limit"</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="s2">"models"</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="c1"># ensemble model</span>
        <span class="k">for</span> <span class="n">sub_model</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="s2">"models"</span><span class="p">]:</span>
            <span class="n">update_model_config</span><span class="p">(</span><span class="n">sub_model</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">update_model_config</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="flatten_deprecated_ensemble_config"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.flatten_deprecated_ensemble_config">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">flatten_deprecated_ensemble_config</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="c1"># Deprecated ensemble is removed from codebase, so this is now just a no-op</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="migrate_to_new_data_handler"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.migrate_to_new_data_handler">[docs]</a><span class="k">def</span> <span class="nf">migrate_to_new_data_handler</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="n">create_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"data.source"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"TSVDataSource"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">rename_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.eval_path"</span><span class="p">,</span> <span class="s2">"data.source.eval_filename"</span><span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.test_path"</span><span class="p">,</span> <span class="s2">"data.source.test_filename"</span><span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.train_path"</span><span class="p">,</span> <span class="s2">"data.source.train_filename"</span><span class="p">)</span>
    <span class="n">columns_to_read</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"columns_to_read"</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">columns_to_read</span><span class="p">:</span>
        <span class="n">rename_parameter</span><span class="p">(</span>
            <span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.columns_to_read"</span><span class="p">,</span> <span class="s2">"data.source.field_names"</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">create_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"data.source.field_names"</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>

    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.append_bos"</span><span class="p">,</span> <span class="s2">"model.inputs.tokens.add_bos_token"</span>
    <span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.append_eos"</span><span class="p">,</span> <span class="s2">"model.inputs.tokens.add_eos_token"</span>
    <span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.max_seq_len"</span><span class="p">,</span> <span class="s2">"model.inputs.tokens.max_seq_len"</span>
    <span class="p">)</span>

    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span> <span class="s2">"features.shared_module_key"</span><span class="p">,</span> <span class="s2">"model.embedding.shared_module_key"</span>
    <span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"features.word_feat.embed_dim"</span><span class="p">,</span> <span class="s2">"model.embedding.embed_dim"</span><span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"features.dense_feat"</span><span class="p">,</span> <span class="s2">"model.inputs.dense"</span><span class="p">)</span>

    <span class="n">create_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"data.batcher"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"PoolingBatcher"</span><span class="p">:</span> <span class="p">{}})</span>
    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.eval_batch_size"</span><span class="p">,</span> <span class="s2">"data.batcher.eval_batch_size"</span>
    <span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.test_batch_size"</span><span class="p">,</span> <span class="s2">"data.batcher.test_batch_size"</span>
    <span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler.train_batch_size"</span><span class="p">,</span> <span class="s2">"data.batcher.train_batch_size"</span>
    <span class="p">)</span>

    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span>
        <span class="s2">"features.word_feat.vocab_size"</span><span class="p">,</span>
        <span class="s2">"model.inputs.tokens.vocab.size_from_data"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span>
        <span class="s2">"features.word_feat.vocab_from_train_data"</span><span class="p">,</span>
        <span class="s2">"model.inputs.tokens.vocab.build_from_data"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rename_parameter</span><span class="p">(</span>
        <span class="n">task</span><span class="p">,</span>
        <span class="s2">"features.word_feat.vocab_file"</span><span class="p">,</span>
        <span class="s2">"model.inputs.tokens.vocab.vocab_files"</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[{</span><span class="s2">"filepath"</span><span class="p">:</span> <span class="n">x</span><span class="p">}],</span>
    <span class="p">)</span>

    <span class="n">rename_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"labels.label_weights"</span><span class="p">,</span> <span class="s2">"model.output_layer.label_weights"</span><span class="p">)</span>

    <span class="n">delete_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"data_handler"</span><span class="p">)</span>
    <span class="n">delete_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"exporter"</span><span class="p">)</span>
    <span class="n">delete_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"features"</span><span class="p">)</span>
    <span class="n">delete_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"featurizer"</span><span class="p">)</span>
    <span class="n">delete_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"labels"</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_lmtask_deprecated"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.remove_lmtask_deprecated">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">remove_lmtask_deprecated</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"LMTask_Deprecated"</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"LMTask_Deprecated"</span><span class="p">)</span>
        <span class="n">migrate_to_new_data_handler</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="p">[</span><span class="s2">"text"</span><span class="p">])</span>
        <span class="n">section</span><span class="p">[</span><span class="s2">"LMTask"</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="remove_docclassificationtask_deprecated"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.remove_docclassificationtask_deprecated">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">remove_docclassificationtask_deprecated</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">find_dicts_containing_key</span><span class="p">(</span>
        <span class="n">json_config</span><span class="p">,</span> <span class="s2">"DocClassificationTask_Deprecated"</span>
    <span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"DocClassificationTask_Deprecated"</span><span class="p">)</span>
        <span class="n">convert</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"convert_to_bytes"</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">section</span><span class="p">[</span><span class="s2">"DocumentClassificationTask"</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
        <span class="n">migrate_to_new_data_handler</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="p">[</span><span class="s2">"doc_label"</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">])</span>
        <span class="n">create_parameter</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s2">"model.inputs.labels.column"</span><span class="p">,</span> <span class="s2">"doc_label"</span><span class="p">)</span>

        <span class="c1"># In DocumentClassificationTask.Config:</span>
        <span class="c1">#   model: BaseModel.Config = DocModel.Config()</span>
        <span class="c1"># It will create a BaseModel if model class is implicit in json.</span>
        <span class="c1"># We make it explicit to avoid errors.</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">"model"</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">"model"</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
                <span class="n">model</span><span class="p">[</span><span class="s2">"model"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"DocModel"</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"model"</span><span class="p">)}</span>

        <span class="k">if</span> <span class="n">convert</span> <span class="ow">and</span> <span class="n">convert</span><span class="p">[</span><span class="s2">"convert_to_bytes"</span><span class="p">]:</span>
            <span class="n">rename</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">"DocModel"</span><span class="p">,</span> <span class="s2">"ByteTokensDocumentModel"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="rename_fl_task"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.rename_fl_task">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">rename_fl_task</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="c1"># remove 'NewDoc' from FL task names</span>
    <span class="k">for</span> <span class="n">trainer_suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"SyncTrainer"</span><span class="p">,</span> <span class="s2">"AsyncTrainer"</span><span class="p">]:</span>
        <span class="n">old_trainer_name</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"FLNewDoc{trainer_suffix}"</span>
        <span class="n">new_trainer_name</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"FL{trainer_suffix}"</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">find_dicts_containing_key</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="n">old_trainer_name</span><span class="p">):</span>
            <span class="n">section</span><span class="p">[</span><span class="n">new_trainer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_trainer_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="upgrade_if_xlm"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.upgrade_if_xlm">[docs]</a><span class="nd">@register_adapter</span><span class="p">(</span><span class="n">from_version</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">upgrade_if_xlm</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make `XLMModel` Union changes for encoder and tokens config.</span>
<span class="sd">    Since they are now unions, insert the old class into the config if</span>
<span class="sd">    no class name is mentioned.</span>
<span class="sd">    """</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">find_parameter</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"task.model"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">and</span> <span class="s2">"XLMModel"</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">find_parameter</span><span class="p">(</span><span class="n">json_config</span><span class="p">,</span> <span class="s2">"task.model.inputs.tokens"</span><span class="p">)</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">"tokens"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">"tokens"</span><span class="p">][</span><span class="s2">"XLMTensorizer"</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>

    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="upgrade_one_version"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.upgrade_one_version">[docs]</a><span class="k">def</span> <span class="nf">upgrade_one_version</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">json_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"version"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">ADAPTERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">current_version</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">adapter</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">f</span><span class="s2">"no adapter found for version {current_version}"</span><span class="p">)</span>
    <span class="n">json_config</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="n">json_config</span><span class="p">)</span>
    <span class="n">eprint</span><span class="p">(</span>
        <span class="n">f</span><span class="s2">"WARNING - Applying old config adapter for version={current_version}. "</span>
        <span class="s2">"Please consider migrating your old configs to the latest version."</span>
    <span class="p">)</span>
    <span class="n">json_config</span><span class="p">[</span><span class="s2">"version"</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_version</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">json_config</span></div>


<div class="viewcode-block" id="upgrade_to_latest"><a class="viewcode-back" href="../../../modules/pytext.config.html#pytext.config.config_adapter.upgrade_to_latest">[docs]</a><span class="k">def</span> <span class="nf">upgrade_to_latest</span><span class="p">(</span><span class="n">json_config</span><span class="p">):</span>
    <span class="n">current_version</span> <span class="o">=</span> <span class="n">json_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"version"</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">current_version</span> <span class="o">&gt;</span> <span class="n">LATEST_VERSION</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">"config version {json_config['version']} shouldn't exceed lastest </span><span class="se">\</span>
<span class="s2">            version {LATEST_VERSION}"</span>
        <span class="p">)</span>
    <span class="k">while</span> <span class="n">current_version</span> <span class="o">!=</span> <span class="n">LATEST_VERSION</span><span class="p">:</span>
        <span class="n">json_config</span> <span class="o">=</span> <span class="n">upgrade_one_version</span><span class="p">(</span><span class="n">json_config</span><span class="p">)</span>
        <span class="n">current_version</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">"version"</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">json_config</span></div>
</pre></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">PyText</a></h1>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../train_your_first_model.html">Train your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../execute_your_first_model.html">Execute your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualize_your_model.html">Visualize Model Training with TensorBoard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytext_models_in_your_app.html">Use PyText models in your app</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../serving_models_in_production.html">Serve Models in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_files.html">Config Files Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_commands.html">Config Commands</a></li>
</ul>
<p class="caption"><span class="caption-text">Training More Advanced Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../atis_tutorial.html">Train Intent-Slot model on ATIS Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hierarchical_intent_slot_tutorial.html">Hierarchical intent and slot filling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../disjoint_multitask_tutorial.html">Multitask training with disjoint datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_training_tutorial.html">Data Parallel Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xlm_r.html">XLM-RoBERTa</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending PyText</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasource_tutorial.html">Custom Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorizer.html">Custom Tensorizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dense.html">Using External Dense Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../create_new_model.html">Creating A New Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hacking_pytext.html">Hacking PyText</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../configs/pytext.html">pytext</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/pytext.html">pytext package</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="../../../index.html">Documentation overview</a><ul>
<li><a href="../../index.html">Module code</a><ul>
<li><a href="../../pytext.html">pytext</a><ul>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" name="q" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div></div>
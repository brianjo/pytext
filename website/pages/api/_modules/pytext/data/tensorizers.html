
<script type="text/javascript" id="documentation_options" data-url_root="./"
  src="/js/documentation_options.js"></script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/doctools.js"></script>
<script type="text/javascript" src="/js/language_data.js"></script>
<script type="text/javascript" src="/js/searchtools.js"></script>
<div class="sphinx"><div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for pytext.data.tensorizers</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">pytext.common</span> <span class="kn">import</span> <span class="n">Padding</span>
<span class="kn">from</span> <span class="nn">pytext.config.component</span> <span class="kn">import</span> <span class="n">Component</span><span class="p">,</span> <span class="n">ComponentType</span><span class="p">,</span> <span class="n">create_component</span>
<span class="kn">from</span> <span class="nn">pytext.data.data_structures.annotation</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">REDUCE</span><span class="p">,</span>
    <span class="n">SHIFT</span><span class="p">,</span>
    <span class="n">Annotation</span><span class="p">,</span>
    <span class="n">is_intent_nonterminal</span><span class="p">,</span>
    <span class="n">is_slot_nonterminal</span><span class="p">,</span>
    <span class="n">is_unsupported</span><span class="p">,</span>
    <span class="n">is_valid_nonterminal</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pytext.data.sources.data_source</span> <span class="kn">import</span> <span class="n">Gazetteer</span>
<span class="kn">from</span> <span class="nn">pytext.data.tokenizers</span> <span class="kn">import</span> <span class="n">Token</span><span class="p">,</span> <span class="n">Tokenizer</span>
<span class="kn">from</span> <span class="nn">pytext.torchscript.tensorizer</span> <span class="kn">import</span> <span class="n">VectorNormalizer</span>
<span class="kn">from</span> <span class="nn">pytext.utils</span> <span class="kn">import</span> <span class="n">cuda</span><span class="p">,</span> <span class="n">precision</span>
<span class="kn">from</span> <span class="nn">pytext.utils.data</span> <span class="kn">import</span> <span class="n">Slot</span>
<span class="kn">from</span> <span class="nn">pytext.utils.file_io</span> <span class="kn">import</span> <span class="n">PathManager</span>
<span class="kn">from</span> <span class="nn">pytext.utils.lazy</span> <span class="kn">import</span> <span class="n">lazy_property</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BOL</span><span class="p">,</span>
    <span class="n">BOS</span><span class="p">,</span>
    <span class="n">BYTE_BOS</span><span class="p">,</span>
    <span class="n">BYTE_EOS</span><span class="p">,</span>
    <span class="n">EOL</span><span class="p">,</span>
    <span class="n">EOS</span><span class="p">,</span>
    <span class="n">PAD</span><span class="p">,</span>
    <span class="n">SpecialToken</span><span class="p">,</span>
    <span class="n">VocabBuilder</span><span class="p">,</span>
    <span class="n">Vocabulary</span><span class="p">,</span>
    <span class="n">align_target_label</span><span class="p">,</span>
    <span class="n">pad_and_tensorize</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="to_device"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.to_device">[docs]</a><span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">to_device</span><span class="p">(</span><span class="n">tensorizer_script_impl</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
    <span class="n">cur_device</span> <span class="o">=</span> <span class="n">tensorizer_script_impl</span><span class="o">.</span><span class="n">device</span>
    <span class="n">tensorizer_script_impl</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
    <span class="k">yield</span>
    <span class="n">tensorizer_script_impl</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">cur_device</span></div>


<div class="viewcode-block" id="tokenize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.tokenize">[docs]</a><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">pre_tokenized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">bos_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">eos_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">pad_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">,</span>
    <span class="n">use_eos_token_for_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">max_seq_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">tokenized</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pre_tokenized</span>
        <span class="ow">or</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)[</span>
            <span class="p">:</span> <span class="n">max_seq_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">bos_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">eos_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">bos_token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_eos_token_for_bos</span><span class="p">:</span>
            <span class="n">bos_token</span> <span class="o">=</span> <span class="n">eos_token</span>
        <span class="n">tokenized</span> <span class="o">=</span> <span class="p">[</span><span class="n">Token</span><span class="p">(</span><span class="n">bos_token</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="n">tokenized</span>
    <span class="k">if</span> <span class="n">eos_token</span><span class="p">:</span>
        <span class="n">tokenized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Token</span><span class="p">(</span><span class="n">eos_token</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tokenized</span><span class="p">:</span>
        <span class="n">tokenized</span> <span class="o">=</span> <span class="p">[</span><span class="n">Token</span><span class="p">(</span><span class="n">pad_token</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

    <span class="n">tokenized_texts</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="o">*</span><span class="p">((</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokenized</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">tokenized_texts</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span></div>


<div class="viewcode-block" id="lookup_tokens"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.lookup_tokens">[docs]</a><span class="k">def</span> <span class="nf">lookup_tokens</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">pre_tokenized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">vocab</span><span class="p">:</span> <span class="n">Vocabulary</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">bos_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">eos_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
    <span class="n">pad_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PAD</span><span class="p">,</span>
    <span class="n">use_eos_token_for_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">max_seq_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">tokenized_texts</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span>
        <span class="n">text</span><span class="p">,</span>
        <span class="n">pre_tokenized</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">bos_token</span><span class="p">,</span>
        <span class="n">eos_token</span><span class="p">,</span>
        <span class="n">pad_token</span><span class="p">,</span>
        <span class="n">use_eos_token_for_bos</span><span class="p">,</span>
        <span class="n">max_seq_len</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">vocab</span><span class="o">.</span><span class="n">lookup_all</span><span class="p">(</span><span class="n">tokenized_texts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span></div>


<div class="viewcode-block" id="TensorizerScriptImpl"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl">[docs]</a><span class="k">class</span> <span class="nc">TensorizerScriptImpl</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>

<div class="viewcode-block" id="TensorizerScriptImpl.set_device"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.set_device">[docs]</a>    <span class="nd">@torch.jit.export</span>
    <span class="k">def</span> <span class="nf">set_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.batch_size"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.batch_size">[docs]</a>    <span class="k">def</span> <span class="nf">batch_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">texts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Empty input for both texts and tokens."</span><span class="p">)</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.row_size"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.row_size">[docs]</a>    <span class="k">def</span> <span class="nf">row_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">texts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Empty input for both texts and tokens."</span><span class="p">)</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.get_texts_by_index"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.get_texts_by_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_texts_by_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">texts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">texts</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.get_tokens_by_index"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.get_tokens_by_index">[docs]</a>    <span class="k">def</span> <span class="nf">get_tokens_by_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
        <span class="k">if</span> <span class="n">tokens</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.tokenize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.tokenize">[docs]</a>    <span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        This functions will receive the inputs from Clients, usually there are</span>
<span class="sd">        two possible inputs</span>
<span class="sd">        1) a row of texts: List[str]</span>
<span class="sd">        2) a row of pre-processed tokens: List[List[str]]</span>

<span class="sd">        Override this function to be TorchScriptable, e.g you need to declare</span>
<span class="sd">        concrete input arguments with type hints.</span>
<span class="sd">        """</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        This functions will receive the outputs from function: tokenize() or</span>
<span class="sd">        will be called directly from PyTextTensorizer function: numberize().</span>

<span class="sd">        Override this function to be TorchScriptable, e.g you need to declare</span>
<span class="sd">        concrete input arguments with type hints.</span>
<span class="sd">        """</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        This functions will receive a list(e.g a batch) of outputs</span>
<span class="sd">        from function numberize(), padding and convert to output tensors.</span>

<span class="sd">        Override this function to be TorchScriptable, e.g you need to declare</span>
<span class="sd">        concrete input arguments with type hints.</span>
<span class="sd">        """</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.tensorize_wrapper"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.tensorize_wrapper">[docs]</a>    <span class="nd">@torch.jit.ignore</span>
    <span class="k">def</span> <span class="nf">tensorize_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        This functions will receive a list(e.g a batch) of outputs</span>
<span class="sd">        from function numberize(), padding and convert to output tensors.</span>

<span class="sd">        It will be called in PyText Tensorizer during training time, this</span>
<span class="sd">        function is not torchscriptiable because it depends on cuda.device().</span>
<span class="sd">        """</span>
        <span class="k">with</span> <span class="n">to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cuda</span><span class="o">.</span><span class="n">device</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensorize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TensorizerScriptImpl.torchscriptify"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TensorizerScriptImpl.torchscriptify">[docs]</a>    <span class="nd">@torch.jit.ignore</span>
    <span class="k">def</span> <span class="nf">torchscriptify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">jit</span><span class="o">.</span><span class="n">script</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Tensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer">[docs]</a><span class="k">class</span> <span class="nc">Tensorizer</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">"""Tensorizers are a component that converts from batches of</span>
<span class="sd">    `pytext.data.type.DataType` instances to tensors. These tensors will eventually</span>
<span class="sd">    be inputs to the model, but the model is aware of the tensorizers and can arrange</span>
<span class="sd">    the tensors they create to conform to its model.</span>

<span class="sd">    Tensorizers have an initialize function. This function allows the tensorizer to</span>
<span class="sd">    read through the training dataset to build up any data that it needs for</span>
<span class="sd">    creating the model. Commonly this is valuable for things like inferring a</span>
<span class="sd">    vocabulary from the training set, or learning the entire set of training labels,</span>
<span class="sd">    or slot labels, etc.</span>
<span class="sd">    """</span>

    <span class="n">__COMPONENT_TYPE__</span> <span class="o">=</span> <span class="n">ComponentType</span><span class="o">.</span><span class="n">TENSORIZER</span>
    <span class="n">__EXPANSIBLE__</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">__TENSORIZER_SCRIPT_IMPL__</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Component</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1"># Indicate if it can be used to generate input Tensors for prediction</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="Tensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_input</span> <span class="o">=</span> <span class="n">is_input</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Generic types don't pickle well pre-3.7, so we don't actually want</span>
<span class="sd">        to store the schema as an attribute. We're already storing all of the</span>
<span class="sd">        columns anyway, so until there's a better solution, schema is a property."""</span>
        <span class="k">return</span> <span class="p">[]</span>

<div class="viewcode-block" id="Tensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Tensorizer.prepare_input"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer.prepare_input">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">""" Return preprocessed input tensors/blob for caffe2 prediction net."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberize</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Tensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="sd">"""Tensorizer knows how to pad and tensorize a batch of it's own output."""</span>
        <span class="k">return</span> <span class="n">batch</span></div>

<div class="viewcode-block" id="Tensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        The initialize function is carefully designed to allow us to read through the</span>
<span class="sd">        training dataset only once, and not store it in memory. As such, it can't itself</span>
<span class="sd">        manually iterate over the data source. Instead, the initialize function is a</span>
<span class="sd">        coroutine, which is sent row data. This should look roughly like::</span>

<span class="sd">            # set up variables here</span>
<span class="sd">            ...</span>
<span class="sd">            try:</span>
<span class="sd">                # start reading through data source</span>
<span class="sd">                while True:</span>
<span class="sd">                    # row has type Dict[str, types.DataType]</span>
<span class="sd">                    row = yield</span>
<span class="sd">                    # update any variables, vocabularies, etc.</span>
<span class="sd">                    ...</span>
<span class="sd">            except GeneratorExit:</span>
<span class="sd">                # finalize your initialization, set instance variables, etc.</span>
<span class="sd">                ...</span>

<span class="sd">        See `WordTokenizer.initialize` for a more concrete example.</span>
<span class="sd">        """</span>
        <span class="k">return</span>
        <span class="c1"># we need yield here to make this function a generator</span>
        <span class="k">yield</span></div>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">tensorizer_script_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Script tensorizer is unpickleable, we use lazy_property for</span>
        <span class="c1"># lazy initialization to construct the object during run time.</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make a shallow copy of state to avoid side effect on the original object</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"tensorizer_script_impl"</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

<div class="viewcode-block" id="Tensorizer.torchscriptify"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.Tensorizer.torchscriptify">[docs]</a>    <span class="k">def</span> <span class="nf">torchscriptify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensorizer_script_impl</span><span class="o">.</span><span class="n">torchscriptify</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="VocabFileConfig"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.VocabFileConfig">[docs]</a><span class="k">class</span> <span class="nc">VocabFileConfig</span><span class="p">(</span><span class="n">Component</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
    <span class="c1">#: File containing tokens to add to vocab (first whitespace-separated entry per</span>
    <span class="c1">#: line)</span>
    <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="c1">#: Whether to skip the first line of the file (e.g. if it is a header line)</span>
    <span class="n">skip_header_line</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1">#: Whether to lowercase each of the tokens in the file</span>
    <span class="n">lowercase_tokens</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1">#: The max number of tokens to add to vocab</span>
    <span class="n">size_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="VocabConfig"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.VocabConfig">[docs]</a><span class="k">class</span> <span class="nc">VocabConfig</span><span class="p">(</span><span class="n">Component</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
    <span class="c1">#: Whether to add tokens from training data to vocab.</span>
    <span class="n">build_from_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1">#: Add `size_from_data` most frequent tokens in training data to vocab (if this</span>
    <span class="c1">#: is 0, add all tokens from training data).</span>
    <span class="n">size_from_data</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">vocab_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">VocabFileConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="TokenTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TokenTensorizer">[docs]</a><span class="k">class</span> <span class="nc">TokenTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Convert text to a list of tokens. Do this based on a tokenizer configuration,</span>
<span class="sd">    and build a vocabulary for numberization. Finally, pad the batch to create</span>
<span class="sd">    a square tensor of the correct size.</span>
<span class="sd">    """</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the text column to parse from the data source.</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"text"</span>
        <span class="c1">#: The tokenizer to use to split input text into tokens.</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
        <span class="n">add_bos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">add_eos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">use_eos_token_for_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">max_seq_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">vocab</span><span class="p">:</span> <span class="n">VocabConfig</span> <span class="o">=</span> <span class="n">VocabConfig</span><span class="p">()</span>
        <span class="n">vocab_file_delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">" "</span>

<div class="viewcode-block" id="TokenTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TokenTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">create_component</span><span class="p">(</span><span class="n">ComponentType</span><span class="o">.</span><span class="n">TOKENIZER</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">text_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">add_bos_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
            <span class="n">add_eos_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
            <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
            <span class="n">max_seq_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
            <span class="n">vocab_config</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span>
            <span class="n">vocab_file_delimiter</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">vocab_file_delimiter</span><span class="p">,</span>
            <span class="n">is_input</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text_column</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">add_bos_token</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
        <span class="n">add_eos_token</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
        <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
        <span class="n">vocab_config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">vocab</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">vocab_file_delimiter</span><span class="o">=</span><span class="s2">" "</span><span class="p">,</span>
        <span class="n">is_input</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_column</span> <span class="o">=</span> <span class="n">text_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">Tokenizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span> <span class="o">=</span> <span class="n">add_bos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span> <span class="o">=</span> <span class="n">add_eos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span> <span class="o">=</span> <span class="n">use_eos_token_for_bos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">max_seq_len</span> <span class="ow">or</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span>  <span class="c1"># large number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span> <span class="o">=</span> <span class="n">vocab_config</span> <span class="ow">or</span> <span class="n">VocabConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_file_delimiter</span> <span class="o">=</span> <span class="n">vocab_file_delimiter</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pre_tokenized</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tokenize</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="n">pre_tokenized</span><span class="o">=</span><span class="n">pre_tokenized</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">bos_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">bos_token</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">eos_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">eos_token</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">pad_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span>
            <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
            <span class="n">max_seq_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lookup_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pre_tokenized</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lookup_tokens</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="n">pre_tokenized</span><span class="o">=</span><span class="n">pre_tokenized</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">vocab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span>
            <span class="n">bos_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">bos_token</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">eos_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">eos_token</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">pad_token</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span>
            <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
            <span class="n">max_seq_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reverse_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_ids</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">token_ids</span><span class="p">]</span>

<div class="viewcode-block" id="TokenTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TokenTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_builder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""Build vocabulary based on training corpus."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span><span class="o">.</span><span class="n">build_from_data</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span><span class="o">.</span><span class="n">vocab_files</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">"`{self.text_column}` column: vocab already provided, skipping "</span>
                    <span class="n">f</span><span class="s2">"adding tokens from data and from vocab files."</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span><span class="o">.</span><span class="n">build_from_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span><span class="o">.</span><span class="n">vocab_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">"To create token tensorizer for '{self.text_column}', either "</span>
                <span class="n">f</span><span class="s2">"`build_from_data` or `vocab_files` must be set."</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="p">:</span>
            <span class="c1"># else means not initialize from scratch, self.vocab_builder</span>
            <span class="c1"># would be set already</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">vocab_builder</span> <span class="ow">or</span> <span class="n">VocabBuilder</span><span class="p">(</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_file_delimiter</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_bos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_eos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span><span class="o">.</span><span class="n">build_from_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_vocab_from_files</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="n">raw_text</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">]</span>
                <span class="n">tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">raw_text</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokenized</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">truncate_to_vocab_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span><span class="o">.</span><span class="n">size_from_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_vocab_from_files</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_add_vocab_from_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vocab_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_config</span><span class="o">.</span><span class="n">vocab_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">PathManager</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vocab_file</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_from_file</span><span class="p">(</span>
                    <span class="n">f</span><span class="p">,</span>
                    <span class="n">vocab_file</span><span class="o">.</span><span class="n">skip_header_line</span><span class="p">,</span>
                    <span class="n">vocab_file</span><span class="o">.</span><span class="n">lowercase_tokens</span><span class="p">,</span>
                    <span class="n">vocab_file</span><span class="o">.</span><span class="n">size_limit</span><span class="p">,</span>
                <span class="p">)</span>

<div class="viewcode-block" id="TokenTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TokenTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Tokenize, look up in vocabulary."""</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_tokens</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">])</span>
        <span class="n">token_ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tokens</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="n">token_ranges</span></div>

<div class="viewcode-block" id="TokenTensorizer.prepare_input"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TokenTensorizer.prepare_input">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Tokenize, look up in vocabulary, return tokenized_texts in raw text"""</span>
        <span class="n">tokenized_texts</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">])</span>
        <span class="n">token_ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenized_texts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenized_texts</span><span class="p">),</span> <span class="n">token_ranges</span></div>

<div class="viewcode-block" id="TokenTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TokenTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">seq_lens</span><span class="p">,</span> <span class="n">token_ranges</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">seq_lens</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">token_ranges</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TokenTensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.TokenTensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="c1"># use seq_len as sort key</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="ByteTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTensorizer">[docs]</a><span class="k">class</span> <span class="nc">ByteTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Turn characters into sequence of int8 bytes. One character will have one</span>
<span class="sd">    or more bytes depending on it's encoding</span>
<span class="sd">    """</span>

    <span class="n">UNK_BYTE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">PAD_BYTE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">NUM</span> <span class="o">=</span> <span class="mi">256</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the text column to parse from the data source.</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"text"</span>
        <span class="n">lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">max_seq_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">add_bos_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">add_eos_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">use_eos_token_for_bos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="ByteTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text_column</span><span class="p">,</span>
        <span class="n">lower</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">max_seq_len</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">add_bos_token</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
        <span class="n">add_eos_token</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
        <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
        <span class="n">is_input</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_column</span> <span class="o">=</span> <span class="n">text_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">max_seq_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span> <span class="o">=</span> <span class="n">add_bos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span> <span class="o">=</span> <span class="n">add_eos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span> <span class="o">=</span> <span class="n">use_eos_token_for_bos</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

<div class="viewcode-block" id="ByteTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Convert text to characters."""</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">:</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">:</span>
            <span class="n">bos</span> <span class="o">=</span> <span class="n">BYTE_EOS</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span> <span class="k">else</span> <span class="n">BYTE_BOS</span>
            <span class="k">if</span> <span class="n">bos</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">'Special token "{}" exists in text "{}". Exit.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bos</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bos</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> <span class="o">+</span> <span class="nb">bytes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">BYTE_EOS</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s1">'Special token "{}" exists in text "{}". Exit.'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">BYTE_EOS</span><span class="p">,</span> <span class="n">text</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytes</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">BYTE_EOS</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span></div>

<div class="viewcode-block" id="ByteTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="nb">bytes</span><span class="p">,</span> <span class="n">bytes_len</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAD_BYTE</span><span class="p">),</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">bytes_len</span><span class="p">)</span></div>

<div class="viewcode-block" id="ByteTensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="c1"># use bytes_len as sort key</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="ByteTokenTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTokenTensorizer">[docs]</a><span class="k">class</span> <span class="nc">ByteTokenTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Turn words into 2-dimensional tensors of int8 bytes. Words are padded to</span>
<span class="sd">    `max_byte_len`. Also computes sequence lengths (1-D tensor) and token lengths</span>
<span class="sd">    (2-D tensor). 0 is the pad byte.</span>
<span class="sd">    """</span>

    <span class="n">NUM_BYTES</span> <span class="o">=</span> <span class="mi">256</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the text column to parse from the data source.</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"text"</span>
        <span class="c1">#: The tokenizer to use to split input text into tokens.</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
        <span class="c1">#: The max token length for input text.</span>
        <span class="n">max_seq_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#: The max byte length for a token.</span>
        <span class="n">max_byte_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="c1">#: Offset to add to all non-padding bytes</span>
        <span class="n">offset_for_non_padding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">add_bos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">add_eos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">use_eos_token_for_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="ByteTokenTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTokenTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">create_component</span><span class="p">(</span><span class="n">ComponentType</span><span class="o">.</span><span class="n">TOKENIZER</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">text_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">max_seq_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
            <span class="n">max_byte_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_byte_len</span><span class="p">,</span>
            <span class="n">offset_for_non_padding</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">offset_for_non_padding</span><span class="p">,</span>
            <span class="n">add_bos_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
            <span class="n">add_eos_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
            <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
            <span class="n">is_input</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text_column</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
        <span class="n">max_byte_len</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">max_byte_len</span><span class="p">,</span>
        <span class="n">offset_for_non_padding</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">offset_for_non_padding</span><span class="p">,</span>
        <span class="n">add_bos_token</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
        <span class="n">add_eos_token</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
        <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
        <span class="n">is_input</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_column</span> <span class="o">=</span> <span class="n">text_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">Tokenizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">max_seq_len</span> <span class="ow">or</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span>  <span class="c1"># large number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_byte_len</span> <span class="o">=</span> <span class="n">max_byte_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset_for_non_padding</span> <span class="o">=</span> <span class="n">offset_for_non_padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span> <span class="o">=</span> <span class="n">add_bos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span> <span class="o">=</span> <span class="n">add_eos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span> <span class="o">=</span> <span class="n">use_eos_token_for_bos</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

<div class="viewcode-block" id="ByteTokenTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTokenTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Convert text to bytes, pad batch."""</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">])[</span>
            <span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">:</span>
            <span class="n">bos</span> <span class="o">=</span> <span class="n">EOS</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span> <span class="k">else</span> <span class="n">BOS</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">Token</span><span class="p">(</span><span class="n">bos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="n">tokens</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">:</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Token</span><span class="p">(</span><span class="n">EOS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">Token</span><span class="p">(</span><span class="n">PAD</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_numberize_token</span><span class="p">(</span><span class="n">token</span><span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_byte_len</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
        <span class="n">token_lengths</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">byte_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">token_bytes</span><span class="p">)</span> <span class="k">for</span> <span class="n">token_bytes</span> <span class="ow">in</span> <span class="nb">bytes</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">token_lengths</span><span class="p">,</span> <span class="n">byte_lengths</span></div>

    <span class="k">def</span> <span class="nf">_numberize_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_for_non_padding</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">()]</span>

<div class="viewcode-block" id="ByteTokenTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTokenTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">pad_token</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">bytes</span><span class="p">,</span> <span class="n">token_lengths</span><span class="p">,</span> <span class="n">byte_lengths</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="c1"># Set bytes shape because byte length should always be `max_byte_len` no</span>
        <span class="c1"># matter how long the bytes in the batch are.</span>
        <span class="n">pad_shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">),</span>
            <span class="n">precision</span><span class="o">.</span><span class="n">pad_length</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">byte_lengths</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_byte_len</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">pad_shape</span><span class="o">=</span><span class="n">pad_shape</span><span class="p">,</span> <span class="n">pad_token</span><span class="o">=</span><span class="n">pad_token</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">token_lengths</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">byte_lengths</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ByteTokenTensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.ByteTokenTensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="CharacterTokenTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.CharacterTokenTensorizer">[docs]</a><span class="k">class</span> <span class="nc">CharacterTokenTensorizer</span><span class="p">(</span><span class="n">TokenTensorizer</span><span class="p">):</span>
    <span class="sd">"""Turn words into 2-dimensional tensors of ints based on their ascii values.</span>
<span class="sd">    Words are padded to the maximum word length (also capped at `max_char_length`).</span>
<span class="sd">    Sequence lengths are the length of each token, 0 for pad token.</span>
<span class="sd">    """</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The max character length for a token.</span>
        <span class="n">max_char_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_char_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">max_char_length</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_char_length</span> <span class="o">=</span> <span class="n">max_char_length</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Don't need to create a vocab</span>
    <span class="n">initialize</span> <span class="o">=</span> <span class="n">Tensorizer</span><span class="o">.</span><span class="n">initialize</span>

<div class="viewcode-block" id="CharacterTokenTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.CharacterTokenTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Convert text to characters, pad batch."""</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">])[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">]</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numberize_token</span><span class="p">(</span><span class="n">token</span><span class="p">)[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_char_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span>
        <span class="p">]</span>
        <span class="n">token_lengths</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">char_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">token_chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">token_chars</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">characters</span><span class="p">,</span> <span class="n">token_lengths</span><span class="p">,</span> <span class="n">char_lengths</span></div>

    <span class="k">def</span> <span class="nf">_numberize_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

<div class="viewcode-block" id="CharacterTokenTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.CharacterTokenTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">characters</span><span class="p">,</span> <span class="n">token_lengths</span><span class="p">,</span> <span class="n">char_lengths</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">characters</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">token_lengths</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">char_lengths</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CharacterTokenTensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.CharacterTokenTensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="LabelTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelTensorizer">[docs]</a><span class="k">class</span> <span class="nc">LabelTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Numberize labels. Label can be used as either input or target """</span>

    <span class="n">__EXPANSIBLE__</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the label column to parse from the data source.</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"label"</span>
        <span class="c1">#: Whether to allow for unknown labels at test/prediction time</span>
        <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#: if vocab should have pad, usually false when label is used as target</span>
        <span class="n">pad_in_vocab</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#: The label values, if known. Will skip initialization step if provided.</span>
        <span class="n">label_vocab</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Indicate if it can be used to generate input Tensors for prediction</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="LabelTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">pad_in_vocab</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">label_vocab</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"label"</span><span class="p">,</span>
        <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">pad_in_vocab</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">label_vocab</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_column</span> <span class="o">=</span> <span class="n">label_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_in_vocab</span> <span class="o">=</span> <span class="n">pad_in_vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">VocabBuilder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_pad</span> <span class="o">=</span> <span class="n">pad_in_vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_unk</span> <span class="o">=</span> <span class="n">allow_unknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">label_vocab</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">label_vocab</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_vocab</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

<div class="viewcode-block" id="LabelTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Look through the dataset for all labels and create a vocab map for them.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_vocab</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_create_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span>
        <span class="n">pad_idx</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_in_vocab</span>
            <span class="k">else</span> <span class="n">Padding</span><span class="o">.</span><span class="n">DEFAULT_LABEL_PAD_IDX</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">pad_idx</span>

<div class="viewcode-block" id="LabelTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Numberize labels."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">lookup_all</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">])</span></div>

<div class="viewcode-block" id="LabelTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LabelListTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelListTensorizer">[docs]</a><span class="k">class</span> <span class="nc">LabelListTensorizer</span><span class="p">(</span><span class="n">LabelTensorizer</span><span class="p">):</span>
    <span class="sd">"""LabelListTensorizer takes a list of labels as input and generate a tuple</span>
<span class="sd">    of tensors (label_idx, list_length).</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"label"</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">label_column</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])]</span>

<div class="viewcode-block" id="LabelListTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelListTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">numberize</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">labels</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span></div>

<div class="viewcode-block" id="LabelListTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelListTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">labels</span><span class="p">,</span> <span class="n">labels_len</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tensorize</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">labels_len</span><span class="p">)</span></div>

<div class="viewcode-block" id="LabelListTensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.LabelListTensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="c1"># use list length as sort key</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="UidTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.UidTensorizer">[docs]</a><span class="k">class</span> <span class="nc">UidTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Numberize user IDs which can be either strings or tensors."""</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"uid"</span>
        <span class="c1"># Allow unknown users during prediction.</span>
        <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="UidTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.UidTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">uid_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"uid"</span><span class="p">,</span>
        <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid_column</span> <span class="o">=</span> <span class="n">uid_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">VocabBuilder</span><span class="p">()</span>
        <span class="c1"># User IDs should have the same lengths so need not to use padding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_pad</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_unk</span> <span class="o">=</span> <span class="n">allow_unknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_row_value_as_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Handle the case that the row value is not a string."""</span>
        <span class="n">row_value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uid_column</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row_value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">row_value</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">),</span> <span class="s2">"Cannot get the value of multi-dimensional tensors."</span>
            <span class="n">row_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row_value</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">row_value</span>

<div class="viewcode-block" id="UidTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.UidTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Look through the dataset for all uids and create a vocab map for them.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="n">uids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_value_as_str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_vocab</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_create_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span>
        <span class="n">pad_idx</span> <span class="o">=</span> <span class="n">Padding</span><span class="o">.</span><span class="n">DEFAULT_LABEL_PAD_IDX</span>
        <span class="k">return</span> <span class="n">vocab</span><span class="p">,</span> <span class="n">pad_idx</span>

<div class="viewcode-block" id="UidTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.UidTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Numberize uids."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">lookup_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_row_value_as_str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span></div>

<div class="viewcode-block" id="UidTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.UidTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SoftLabelTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SoftLabelTensorizer">[docs]</a><span class="k">class</span> <span class="nc">SoftLabelTensorizer</span><span class="p">(</span><span class="n">LabelTensorizer</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Handles numberizing labels for knowledge distillation. This still requires the same</span>
<span class="sd">    label column as `LabelTensorizer` for the "true" label, but also processes soft</span>
<span class="sd">    "probabilistic" labels generated from a teacher model, via three new columns.</span>
<span class="sd">    """</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">LabelTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="n">probs_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"target_probs"</span>
        <span class="n">logits_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"target_logits"</span>
        <span class="n">labels_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"target_labels"</span>

<div class="viewcode-block" id="SoftLabelTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SoftLabelTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">pad_in_vocab</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">label_vocab</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">probs_column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">logits_column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">labels_column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"label"</span><span class="p">,</span>
        <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">pad_in_vocab</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">label_vocab</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">probs_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"target_probs"</span><span class="p">,</span>
        <span class="n">logits_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"target_logits"</span><span class="p">,</span>
        <span class="n">labels_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"target_labels"</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">label_column</span><span class="p">,</span> <span class="n">allow_unknown</span><span class="p">,</span> <span class="n">pad_in_vocab</span><span class="p">,</span> <span class="n">label_vocab</span><span class="p">,</span> <span class="n">is_input</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs_column</span> <span class="o">=</span> <span class="n">probs_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logits_column</span> <span class="o">=</span> <span class="n">logits_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_column</span> <span class="o">=</span> <span class="n">labels_column</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs_column</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logits_column</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_column</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]),</span>
        <span class="p">]</span>

<div class="viewcode-block" id="SoftLabelTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SoftLabelTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Numberize hard and soft labels"""</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">lookup_all</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">])</span>
        <span class="n">row_labels</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_column</span><span class="p">]</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">align_target_label</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">probs_column</span><span class="p">],</span> <span class="n">row_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">align_target_label</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">logits_column</span><span class="p">],</span> <span class="n">row_labels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">logits</span></div>

<div class="viewcode-block" id="SoftLabelTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SoftLabelTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">logits</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="c1"># Set probs and logits shape because they should not change with fp16</span>
        <span class="n">probs_shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">probs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">pad_shape</span><span class="o">=</span><span class="n">probs_shape</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">pad_shape</span><span class="o">=</span><span class="n">probs_shape</span><span class="p">),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="NumericLabelTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.NumericLabelTensorizer">[docs]</a><span class="k">class</span> <span class="nc">NumericLabelTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Numberize numeric labels."""</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the label column to parse from the data source.</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"label"</span>
        <span class="c1">#: If provided, the range of values the raw label can be. Will rescale the</span>
        <span class="c1">#: label values to be within [0, 1].</span>
        <span class="n">rescale_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Indicate if it can be used to generate input Tensors for prediction</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="NumericLabelTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.NumericLabelTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">rescale_range</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
        <span class="n">rescale_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">rescale_range</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_column</span> <span class="o">=</span> <span class="n">label_column</span>
        <span class="k">if</span> <span class="n">rescale_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rescale_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">assert</span> <span class="n">rescale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rescale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rescale_range</span> <span class="o">=</span> <span class="n">rescale_range</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

<div class="viewcode-block" id="NumericLabelTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.NumericLabelTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Numberize labels."""</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_column</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">label</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">label</span></div>

<div class="viewcode-block" id="NumericLabelTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.NumericLabelTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FloatListTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatListTensorizer">[docs]</a><span class="k">class</span> <span class="nc">FloatListTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Numberize numeric labels."""</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the label column to parse from the data source.</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">error_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">dim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># If you wish to normalize the training data here, you probably also</span>
        <span class="c1"># want to normalize the inference data. This is currently supported with</span>
        <span class="c1"># TorchScript models (see DocModel). See T48207828 for progress on</span>
        <span class="c1"># supporting Caffe2 models.</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="FloatListTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatListTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">error_check</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">normalize</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">error_check</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">dim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_check</span> <span class="o">=</span> <span class="n">error_check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span> <span class="o">=</span> <span class="n">VectorNormalizer</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">normalize</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_check</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s2">"Error check requires dim"</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])]</span>

<div class="viewcode-block" id="FloatListTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatListTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">do_normalization</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">calculate_feature_stats</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">update_meta_data</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">calculate_feature_stats</span><span class="p">()</span></div>

<div class="viewcode-block" id="FloatListTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatListTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">dense</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_check</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">dense</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span>
            <span class="p">),</span> <span class="n">f</span><span class="s2">"Dense feature didn't match expected dimension {self.dim}: {dense}"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalizer</span><span class="o">.</span><span class="n">normalize</span><span class="p">([</span><span class="n">dense</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="FloatListTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatListTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<span class="n">NO_LABEL</span> <span class="o">=</span> <span class="n">SpecialToken</span><span class="p">(</span><span class="s2">"NoLabel"</span><span class="p">)</span>


<div class="viewcode-block" id="SlotLabelTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SlotLabelTensorizer">[docs]</a><span class="k">class</span> <span class="nc">SlotLabelTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""Numberize word/slot labels."""</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the slot label column to parse from the data source.</span>
        <span class="n">slot_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"slots"</span>
        <span class="c1">#: The name of the text column to parse from the data source.</span>
        <span class="c1">#: We need this to be able to generate tensors which correspond to input text.</span>
        <span class="n">text_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"text"</span>
        <span class="c1">#: The tokenizer to use to split input text into tokens. This should be</span>
        <span class="c1">#: configured in a way which yields tokens consistent with the tokens input to</span>
        <span class="c1">#: or output by a model, so that the labels generated by this tensorizer</span>
        <span class="c1">#: will match the indices of the model's tokens.</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
        <span class="c1">#: Whether to allow for unknown labels at test/prediction time</span>
        <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># Indicate if it can be used to generate input Tensors for prediction</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="SlotLabelTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SlotLabelTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">create_component</span><span class="p">(</span><span class="n">ComponentType</span><span class="o">.</span><span class="n">TOKENIZER</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">slot_column</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span>
            <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">slot_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">slot_column</span><span class="p">,</span>
        <span class="n">text_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">allow_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">allow_unknown</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slot_column</span> <span class="o">=</span> <span class="n">slot_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_column</span> <span class="o">=</span> <span class="n">text_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span> <span class="o">=</span> <span class="n">allow_unknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">Tokenizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_idx</span> <span class="o">=</span> <span class="n">Padding</span><span class="o">.</span><span class="n">DEFAULT_LABEL_PAD_IDX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">VocabBuilder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">NO_LABEL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_pad</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_unk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unknown</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_column</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Slot</span><span class="p">])]</span>

<div class="viewcode-block" id="SlotLabelTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SlotLabelTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""Look through the dataset for all labels and create a vocab map for them."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="n">slots</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_column</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span></div>

<div class="viewcode-block" id="SlotLabelTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SlotLabelTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Turn slot labels and text into a list of token labels with the same</span>
<span class="sd">        length as the number of tokens in the text.</span>
<span class="sd">        """</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slot_column</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">]</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">indexed_tokens</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_slot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_token</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">current_token</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="ow">and</span> <span class="n">current_slot</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">slots</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">indexed_tokens</span><span class="p">[</span><span class="n">current_token</span><span class="p">]</span>
            <span class="n">slot</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="n">current_slot</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">slot</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
                <span class="n">current_slot</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_token</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slot</span><span class="o">.</span><span class="n">label</span> <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">slot</span><span class="o">.</span><span class="n">start</span> <span class="k">else</span> <span class="n">NO_LABEL</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">NO_LABEL</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">-</span> <span class="n">current_token</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">lookup_all</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlotLabelTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SlotLabelTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SlotLabelTensorizerExpansible"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SlotLabelTensorizerExpansible">[docs]</a><span class="k">class</span> <span class="nc">SlotLabelTensorizerExpansible</span><span class="p">(</span><span class="n">SlotLabelTensorizer</span><span class="p">):</span>
    <span class="sd">"""Create a base SlotLabelTensorizer to support selecting different</span>
<span class="sd">       types in ModelInput."""</span>

    <span class="n">__EXPANSIBLE__</span> <span class="o">=</span> <span class="bp">True</span></div>


<div class="viewcode-block" id="GazetteerTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.GazetteerTensorizer">[docs]</a><span class="k">class</span> <span class="nc">GazetteerTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Create 3 tensors for dict features.</span>

<span class="sd">    - idx: index of feature in token order.</span>
<span class="sd">    - weights: weight of feature in token order.</span>
<span class="sd">    - lens: number of features per token.</span>

<span class="sd">    For each input token, there will be the same number of `idx` and `weights` entries.</span>
<span class="sd">    (equal to the max number of features any token has in this row). The values</span>
<span class="sd">    in `lens` will tell how many of these features are actually used per token.</span>

<span class="sd">    Input format for the dict column is json and should be a list of dictionaries</span>
<span class="sd">    containing the "features" and their weight for each relevant "tokenIdx". Example:</span>
<span class="sd">    ::</span>

<span class="sd">        text: "Order coffee from Starbucks please"</span>
<span class="sd">        dict: [</span>
<span class="sd">            {"tokenIdx": 1, "features": {"drink/beverage": 0.8, "music/song": 0.2}},</span>
<span class="sd">            {"tokenIdx": 3, "features": {"store/coffee_shop": 1.0}}</span>
<span class="sd">        ]</span>

<span class="sd">    if we assume this vocab</span>
<span class="sd">    ::</span>

<span class="sd">        vocab = {</span>
<span class="sd">            UNK: 0, PAD: 1,</span>
<span class="sd">            "drink/beverage": 2, "music/song": 3, "store/coffee_shop": 4</span>
<span class="sd">        }</span>

<span class="sd">    this example will result in those tensors:</span>
<span class="sd">    ::</span>

<span class="sd">        idx =     [1,   1,   2,   3,   1,   1,   4,   1,   1,   1]</span>
<span class="sd">        weights = [0.0, 0.0, 0.8, 0.2, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0]</span>
<span class="sd">        lens =    [1,        2,        1,        1,        1]</span>

<span class="sd">    """</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="n">text_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"text"</span>
        <span class="n">dict_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"dict"</span>
        <span class="c1">#: tokenizer to split text and create dict tensors of the same size.</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

<div class="viewcode-block" id="GazetteerTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.GazetteerTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">create_component</span><span class="p">(</span><span class="n">ComponentType</span><span class="o">.</span><span class="n">TOKENIZER</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">dict_column</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">text_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span>
        <span class="n">dict_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">dict_column</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_column</span> <span class="o">=</span> <span class="n">text_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_column</span> <span class="o">=</span> <span class="n">dict_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">Tokenizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">VocabBuilder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_column</span><span class="p">,</span> <span class="n">Gazetteer</span><span class="p">)]</span>

<div class="viewcode-block" id="GazetteerTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.GazetteerTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Look through the dataset for all dict features to create vocab.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="k">for</span> <span class="n">token_dict</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_column</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">token_dict</span><span class="p">[</span><span class="s2">"features"</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span></div>

<div class="viewcode-block" id="GazetteerTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.GazetteerTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Numberize dict features. Fill in for tokens with no features with</span>
<span class="sd">        PAD and weight 0.0. All tokens need to have at least one entry.</span>
<span class="sd">        Tokens with more than one feature will have multiple idx and weight</span>
<span class="sd">        added in sequence.</span>
<span class="sd">        """</span>

        <span class="n">num_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_column</span><span class="p">]))</span>
        <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s2">"features"</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_column</span><span class="p">])</span>
        <span class="n">res_idx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_labels</span> <span class="o">*</span> <span class="n">num_tokens</span><span class="p">)</span>
        <span class="n">res_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_labels</span> <span class="o">*</span> <span class="n">num_tokens</span><span class="p">)</span>
        <span class="n">res_lens</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tokens</span>
        <span class="k">for</span> <span class="n">dict_feature</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dict_column</span><span class="p">]:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">dict_feature</span><span class="p">[</span><span class="s2">"tokenIdx"</span><span class="p">]</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="n">dict_feature</span><span class="p">[</span><span class="s2">"features"</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">num_labels</span>
            <span class="n">res_lens</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
            <span class="c1"># write values at the correct pos</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">feats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">res_idx</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">lookup_all</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">res_weights</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">res_idx</span><span class="p">,</span> <span class="n">res_weights</span><span class="p">,</span> <span class="n">res_lens</span></div>

<div class="viewcode-block" id="GazetteerTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.GazetteerTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="c1"># Pad a minibatch of dictionary features to be</span>
        <span class="c1"># batch_size * max_number_of_words * max_number_of_features</span>
        <span class="c1"># unpack the minibatch</span>
        <span class="n">feats</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">lengths</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">lengths_flattened</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l_list</span> <span class="ow">in</span> <span class="n">lengths</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">l_list</span><span class="p">]</span>
        <span class="n">seq_lens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">l_list</span><span class="p">)</span> <span class="k">for</span> <span class="n">l_list</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">]</span>
        <span class="n">max_ex_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">seq_lens</span><span class="p">)</span>
        <span class="n">max_feat_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lengths_flattened</span><span class="p">)</span>
        <span class="n">all_lengths</span><span class="p">,</span> <span class="n">all_feats</span><span class="p">,</span> <span class="n">all_weights</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">seq_len</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seq_lens</span><span class="p">):</span>
            <span class="n">ex_feats</span><span class="p">,</span> <span class="n">ex_weights</span><span class="p">,</span> <span class="n">ex_lengths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">feats_lengths</span><span class="p">,</span> <span class="n">feats_vals</span><span class="p">,</span> <span class="n">feats_weights</span> <span class="o">=</span> <span class="n">lengths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">feats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">max_feat_len_example</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">feats_lengths</span><span class="p">)</span>
            <span class="n">r_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">feats_lengths</span><span class="p">:</span>
                <span class="c1"># The dict feats obtained from the featurizer will have necessary</span>
                <span class="c1"># padding at the utterance level. Therefore we move the offset by</span>
                <span class="c1"># max feature length in the example.</span>
                <span class="n">ex_feats</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">feats_vals</span><span class="p">[</span><span class="n">r_offset</span> <span class="p">:</span> <span class="n">r_offset</span> <span class="o">+</span> <span class="n">max_feat_len_example</span><span class="p">])</span>
                <span class="n">ex_feats</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_feat_len</span> <span class="o">-</span> <span class="n">max_feat_len_example</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">ex_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">feats_weights</span><span class="p">[</span><span class="n">r_offset</span> <span class="p">:</span> <span class="n">r_offset</span> <span class="o">+</span> <span class="n">max_feat_len_example</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">ex_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_feat_len</span> <span class="o">-</span> <span class="n">max_feat_len_example</span><span class="p">))</span>
                <span class="n">r_offset</span> <span class="o">+=</span> <span class="n">max_feat_len_example</span>
            <span class="n">ex_lengths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">feats_lengths</span><span class="p">)</span>
            <span class="c1"># Pad examples</span>
            <span class="n">ex_padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_ex_len</span> <span class="o">-</span> <span class="n">seq_len</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_feat_len</span>
            <span class="n">ex_feats</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()]</span> <span class="o">*</span> <span class="n">ex_padding</span><span class="p">)</span>
            <span class="n">ex_weights</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ex_padding</span><span class="p">)</span>
            <span class="n">ex_lengths</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_ex_len</span> <span class="o">-</span> <span class="n">seq_len</span><span class="p">))</span>
            <span class="n">all_feats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex_feats</span><span class="p">)</span>
            <span class="n">all_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex_weights</span><span class="p">)</span>
            <span class="n">all_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex_lengths</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">all_feats</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">all_weights</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
            <span class="n">cuda</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">all_lengths</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="SeqTokenTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SeqTokenTensorizer">[docs]</a><span class="k">class</span> <span class="nc">SeqTokenTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Tensorize a sequence of sentences. The input is a list of strings,</span>
<span class="sd">    like this one:</span>
<span class="sd">    ::</span>

<span class="sd">        ["where do you wanna meet?", "MPK"]</span>

<span class="sd">    if we assume this vocab</span>
<span class="sd">    ::</span>

<span class="sd">        vocab  {</span>
<span class="sd">          UNK: 0, PAD: 1,</span>
<span class="sd">          'where': 2, 'do': 3, 'you': 4, 'wanna': 5, 'meet?': 6, 'mpk': 7</span>
<span class="sd">        }</span>

<span class="sd">    this example will result in those tensors:</span>
<span class="sd">    ::</span>

<span class="sd">        idx = [[2, 3, 4, 5, 6], [7, 1, 1, 1, 1]]</span>
<span class="sd">        seq_len = [2]</span>

<span class="sd">    If you're using BOS, EOS, BOL and EOL, the vocab will look like this</span>
<span class="sd">    ::</span>

<span class="sd">        vocab  {</span>
<span class="sd">          UNK: 0, PAD: 1,  BOS: 2, EOS: 3, BOL: 4, EOL: 5</span>
<span class="sd">          'where': 6, 'do': 7, 'you': 8, 'wanna': 9, 'meet?': 10, 'mpk': 11</span>
<span class="sd">        }</span>

<span class="sd">    this example will result in those tensors:</span>
<span class="sd">    ::</span>

<span class="sd">        idx = [</span>
<span class="sd">            [2,  4, 3, 1, 1,  1, 1],</span>
<span class="sd">            [2,  6, 7, 8, 9, 10, 3],</span>
<span class="sd">            [2, 11, 3, 1, 1,  1, 1],</span>
<span class="sd">            [2,  5, 3, 1, 1,  1, 1]</span>
<span class="sd">        ]</span>
<span class="sd">        seq_len = [4]</span>

<span class="sd">    """</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"text_seq"</span>
        <span class="n">max_seq_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1">#: sentence markers</span>
        <span class="n">add_bos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">add_eos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">use_eos_token_for_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#: list markers</span>
        <span class="n">add_bol_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">add_eol_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">use_eol_token_for_bol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1">#: The tokenizer to use to split input text into tokens.</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>

<div class="viewcode-block" id="SeqTokenTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SeqTokenTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">create_component</span><span class="p">(</span><span class="n">ComponentType</span><span class="o">.</span><span class="n">TOKENIZER</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">add_bos_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
            <span class="n">add_eos_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
            <span class="n">use_eos_token_for_bos</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
            <span class="n">add_bol_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_bol_token</span><span class="p">,</span>
            <span class="n">add_eol_token</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">add_eol_token</span><span class="p">,</span>
            <span class="n">use_eol_token_for_bol</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">use_eol_token_for_bol</span><span class="p">,</span>
            <span class="n">max_seq_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
            <span class="n">is_input</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">add_bos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">add_bos_token</span><span class="p">,</span>
        <span class="n">add_eos_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">add_eos_token</span><span class="p">,</span>
        <span class="n">use_eos_token_for_bos</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span><span class="p">,</span>
        <span class="n">add_bol_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">add_bol_token</span><span class="p">,</span>
        <span class="n">add_eol_token</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">add_eol_token</span><span class="p">,</span>
        <span class="n">use_eol_token_for_bol</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_eol_token_for_bol</span><span class="p">,</span>
        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">max_seq_len</span><span class="p">,</span>
        <span class="n">vocab</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="ow">or</span> <span class="n">Tokenizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span> <span class="o">=</span> <span class="n">add_bos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span> <span class="o">=</span> <span class="n">add_eos_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_eos_token_for_bos</span> <span class="o">=</span> <span class="n">use_eos_token_for_bos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bol_token</span> <span class="o">=</span> <span class="n">add_bol_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_eol_token</span> <span class="o">=</span> <span class="n">add_eol_token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_eol_token_for_bol</span> <span class="o">=</span> <span class="n">use_eol_token_for_bol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_len</span> <span class="o">=</span> <span class="n">max_seq_len</span> <span class="ow">or</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span>  <span class="c1"># large number</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])]</span>

<div class="viewcode-block" id="SeqTokenTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SeqTokenTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_builder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""Build vocabulary based on training corpus."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">vocab_builder</span> <span class="ow">or</span> <span class="n">VocabBuilder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_bos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bos_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_eos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eos_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_bol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bol_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_eol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eol_token</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="k">for</span> <span class="n">raw_text</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">]:</span>
                    <span class="n">tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">raw_text</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokenized</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span></div>

    <span class="n">_lookup_tokens</span> <span class="o">=</span> <span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">_lookup_tokens</span>
    <span class="n">_tokenize</span> <span class="o">=</span> <span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">_tokenize</span>

<div class="viewcode-block" id="SeqTokenTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SeqTokenTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Tokenize, look up in vocabulary."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">raw_token_output</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="SeqTokenTensorizer.prepare_input"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SeqTokenTensorizer.prepare_input">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Tokenize, return tokenized_texts in raw text"""</span>
        <span class="n">seq</span><span class="p">,</span> <span class="n">seq_lens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">raw_token_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># convert all special tokens to str</span>
        <span class="k">return</span> <span class="p">[[</span><span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sen</span><span class="p">]</span> <span class="k">for</span> <span class="n">sen</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">],</span> <span class="n">seq_lens</span></div>

    <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">raw_token_output</span><span class="p">):</span>
        <span class="n">sentence_process_fn</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize</span> <span class="k">if</span> <span class="n">raw_token_output</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_tokens</span>
        <span class="p">)</span>
        <span class="n">pad_token</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">pad_token</span> <span class="k">if</span> <span class="n">raw_token_output</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bol_token</span><span class="p">:</span>
            <span class="n">bol</span> <span class="o">=</span> <span class="n">EOL</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_eol_token_for_bol</span> <span class="k">else</span> <span class="n">BOL</span>
            <span class="n">tokens</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sentence_process_fn</span><span class="p">(</span><span class="n">pre_tokenized</span><span class="o">=</span><span class="p">[</span><span class="n">Token</span><span class="p">(</span><span class="n">bol</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">raw_text</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">]:</span>
            <span class="n">tokens</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sentence_process_fn</span><span class="p">(</span><span class="n">raw_text</span><span class="p">)</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_eol_token</span><span class="p">:</span>
            <span class="n">tokens</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sentence_process_fn</span><span class="p">(</span><span class="n">pre_tokenized</span><span class="o">=</span><span class="p">[</span><span class="n">Token</span><span class="p">(</span><span class="n">EOL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>

        <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span> <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="n">pad_len</span> <span class="o">=</span> <span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pad_len</span><span class="p">:</span>
                <span class="n">sentence</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pad_token</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span>
        <span class="k">return</span> <span class="n">seq</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>

<div class="viewcode-block" id="SeqTokenTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SeqTokenTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">seq_lens</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">()),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">seq_lens</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SeqTokenTensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.SeqTokenTensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="c1"># use seq_len as sort key</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="AnnotationNumberizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.AnnotationNumberizer">[docs]</a><span class="k">class</span> <span class="nc">AnnotationNumberizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Not really a Tensorizer (since it does not create tensors) but technically</span>
<span class="sd">    serves the same function. This class parses Annotations in the format below</span>
<span class="sd">    and extracts the actions (type List[List[int]])</span>
<span class="sd">    ::</span>

<span class="sd">        [IN:GET_ESTIMATED_DURATION How long will it take to [SL:METHOD_TRAVEL</span>
<span class="sd">        drive ] from [SL:SOURCE Chicago ] to [SL:DESTINATION Mississippi ] ]</span>

<span class="sd">    Extraction algorithm is handled by Annotation class. We only care about</span>
<span class="sd">    the list of actions, which before vocab index lookups would look like:</span>
<span class="sd">    ::</span>

<span class="sd">        [</span>
<span class="sd">            IN:GET_ESTIMATED_DURATION, SHIFT, SHIFT, SHIFT, SHIFT, SHIFT, SHIFT,</span>
<span class="sd">            SL:METHOD_TRAVEL, SHIFT, REDUCE,</span>
<span class="sd">            SHIFT,</span>
<span class="sd">            SL:SOURCE, SHIFT, REDUCE,</span>
<span class="sd">            SHIFT,</span>
<span class="sd">            SL:DESTINATION, SHIFT, REDUCE,</span>
<span class="sd">        ]</span>

<span class="sd">    """</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"seqlogical"</span>

<div class="viewcode-block" id="AnnotationNumberizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.AnnotationNumberizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">is_input</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">vocab</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>

<div class="viewcode-block" id="AnnotationNumberizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.AnnotationNumberizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_builder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""Build vocabulary based on training corpus."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">vocab_builder</span> <span class="ow">or</span> <span class="n">VocabBuilder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_unk</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">use_pad</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">Annotation</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">])</span>
                <span class="n">actions</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">to_actions</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shift_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">[</span><span class="n">SHIFT</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reduce_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="p">[</span><span class="n">REDUCE</span><span class="p">]</span>

            <span class="k">def</span> <span class="nf">filterVocab</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">nt</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">nt</span><span class="p">)]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ignore_subNTs_roots</span> <span class="o">=</span> <span class="n">filterVocab</span><span class="p">(</span><span class="n">is_unsupported</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_NT_idxs</span> <span class="o">=</span> <span class="n">filterVocab</span><span class="p">(</span><span class="n">is_valid_nonterminal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_IN_idxs</span> <span class="o">=</span> <span class="n">filterVocab</span><span class="p">(</span><span class="n">is_intent_nonterminal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_SL_idxs</span> <span class="o">=</span> <span class="n">filterVocab</span><span class="p">(</span><span class="n">is_slot_nonterminal</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnnotationNumberizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.AnnotationNumberizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">"""Tokenize, look up in vocabulary."""</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">Annotation</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">lookup_all</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">to_actions</span><span class="p">())</span></div>

<div class="viewcode-block" id="AnnotationNumberizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.AnnotationNumberizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">batch</span></div></div>


<div class="viewcode-block" id="MetricTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.MetricTensorizer">[docs]</a><span class="k">class</span> <span class="nc">MetricTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""A tensorizer which use other tensorizers' numerized data.</span>
<span class="sd">       Used mostly for metric reporting."""</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">indexes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="c1"># Indicate if it can be used to generate input Tensors for prediction</span>
        <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="MetricTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.MetricTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">indexes</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">indexes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">indexes</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

<div class="viewcode-block" id="MetricTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.MetricTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="c1"># metric tensorizer will depends on other tensorizers' numeric result</span>
        <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="MetricTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.MetricTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div></div>


<div class="viewcode-block" id="NtokensTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.NtokensTensorizer">[docs]</a><span class="k">class</span> <span class="nc">NtokensTensorizer</span><span class="p">(</span><span class="n">MetricTensorizer</span><span class="p">):</span>
    <span class="sd">"""A tensorizer which will reference another tensorizer's numerized data</span>
<span class="sd">       to calculate the num tokens.</span>
<span class="sd">       Used for calculating tokens per second."""</span>

<div class="viewcode-block" id="NtokensTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.NtokensTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">ntokens</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">):</span>
            <span class="n">ntokens</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">sample</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ntokens</span></div></div>


<div class="viewcode-block" id="FloatTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatTensorizer">[docs]</a><span class="k">class</span> <span class="nc">FloatTensorizer</span><span class="p">(</span><span class="n">Tensorizer</span><span class="p">):</span>
    <span class="sd">"""A tensorizer for reading in scalars from the data."""</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">Tensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1">#: The name of the column to parse from the data source.</span>
        <span class="n">column</span><span class="p">:</span> <span class="nb">str</span>

<div class="viewcode-block" id="FloatTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">is_input</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_input</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">is_input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">is_input</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="nb">float</span><span class="p">)]</span>

<div class="viewcode-block" id="FloatTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">]</span></div>

<div class="viewcode-block" id="FloatTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.FloatTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cuda</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="initialize_tensorizers"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.tensorizers.initialize_tensorizers">[docs]</a><span class="k">def</span> <span class="nf">initialize_tensorizers</span><span class="p">(</span><span class="n">tensorizers</span><span class="p">,</span> <span class="n">data_source</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">"""A utility function to stream a data source to the initialize functions</span>
<span class="sd">    of a dict of tensorizers."""</span>
    <span class="n">initializers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">tensorizer</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">from_scratch</span><span class="o">=</span><span class="n">from_scratch</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tensorizer</span><span class="p">,</span> <span class="s2">"vocab"</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">tensorizer</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tensorizer</span> <span class="ow">in</span> <span class="n">tensorizers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">init</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>  <span class="c1"># kick</span>
            <span class="n">initializers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">initializers</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_source</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="n">initializers</span><span class="p">:</span>
                <span class="n">init</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>
</pre></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">PyText</a></h1>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../train_your_first_model.html">Train your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../execute_your_first_model.html">Execute your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualize_your_model.html">Visualize Model Training with TensorBoard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytext_models_in_your_app.html">Use PyText models in your app</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../serving_models_in_production.html">Serve Models in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_files.html">Config Files Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_commands.html">Config Commands</a></li>
</ul>
<p class="caption"><span class="caption-text">Training More Advanced Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../atis_tutorial.html">Train Intent-Slot model on ATIS Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hierarchical_intent_slot_tutorial.html">Hierarchical intent and slot filling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../disjoint_multitask_tutorial.html">Multitask training with disjoint datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_training_tutorial.html">Data Parallel Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xlm_r.html">XLM-RoBERTa</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending PyText</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasource_tutorial.html">Custom Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorizer.html">Custom Tensorizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dense.html">Using External Dense Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../create_new_model.html">Creating A New Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hacking_pytext.html">Hacking PyText</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../configs/pytext.html">pytext</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/pytext.html">pytext package</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="../../../index.html">Documentation overview</a><ul>
<li><a href="../../index.html">Module code</a><ul>
<li><a href="../../pytext.html">pytext</a><ul>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" name="q" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div></div>
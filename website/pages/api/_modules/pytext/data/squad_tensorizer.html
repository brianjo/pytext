
<script type="text/javascript" id="documentation_options" data-url_root="./"
  src="/js/documentation_options.js"></script>
<script type="text/javascript" src="/js/jquery.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/doctools.js"></script>
<script type="text/javascript" src="/js/language_data.js"></script>
<script type="text/javascript" src="/js/searchtools.js"></script>
<div class="sphinx"><div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for pytext.data.squad_tensorizer</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright (c) Facebook, Inc. and its affiliates. All Rights Reserved</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">pytext.config.component</span> <span class="kn">import</span> <span class="n">ComponentType</span><span class="p">,</span> <span class="n">create_component</span>
<span class="kn">from</span> <span class="nn">pytext.data.tensorizers</span> <span class="kn">import</span> <span class="n">TokenTensorizer</span>
<span class="kn">from</span> <span class="nn">pytext.data.tokenizers</span> <span class="kn">import</span> <span class="n">Tokenizer</span><span class="p">,</span> <span class="n">WordPieceTokenizer</span>
<span class="kn">from</span> <span class="nn">pytext.data.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BOS</span><span class="p">,</span>
    <span class="n">EOS</span><span class="p">,</span>
    <span class="n">MASK</span><span class="p">,</span>
    <span class="n">PAD</span><span class="p">,</span>
    <span class="n">UNK</span><span class="p">,</span>
    <span class="n">VocabBuilder</span><span class="p">,</span>
    <span class="n">Vocabulary</span><span class="p">,</span>
    <span class="n">pad_and_tensorize</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="SquadTensorizer"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizer">[docs]</a><span class="k">class</span> <span class="nc">SquadTensorizer</span><span class="p">(</span><span class="n">TokenTensorizer</span><span class="p">):</span>
    <span class="sd">"""Produces inputs and answer spans for Squad."""</span>

    <span class="n">__EXPANSIBLE__</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SPAN_PAD_IDX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">TokenTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="c1"># for model inputs</span>
        <span class="n">doc_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"doc"</span>
        <span class="n">ques_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"question"</span>
        <span class="c1"># for labels</span>
        <span class="n">answers_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"answers"</span>
        <span class="n">answer_starts_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"answer_starts"</span>
        <span class="c1"># Since Tokenizer is __EXPANSIBLE__, we don't need a Union type to</span>
        <span class="c1"># support WordPieceTokenizer.</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">split_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">"\W+"</span><span class="p">)</span>
        <span class="n">max_ques_seq_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="n">max_doc_seq_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span>

<div class="viewcode-block" id="SquadTensorizer.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizer.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">create_component</span><span class="p">(</span><span class="n">ComponentType</span><span class="o">.</span><span class="n">TOKENIZER</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="n">vocab</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">WordPieceTokenizer</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Using WordPieceTokenizer"</span><span class="p">)</span>
            <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"[UNK]"</span><span class="p">:</span> <span class="n">UNK</span><span class="p">,</span>
                <span class="s2">"[PAD]"</span><span class="p">:</span> <span class="n">PAD</span><span class="p">,</span>
                <span class="s2">"[CLS]"</span><span class="p">:</span> <span class="n">BOS</span><span class="p">,</span>
                <span class="s2">"[SEP]"</span><span class="p">:</span> <span class="n">EOS</span><span class="p">,</span>
                <span class="s2">"[MASK]"</span><span class="p">:</span> <span class="n">MASK</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">vocab</span> <span class="o">=</span> <span class="n">Vocabulary</span><span class="p">(</span>
                <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
                <span class="n">replacements</span><span class="o">=</span><span class="n">replacements</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">doc_tensorizer</span> <span class="o">=</span> <span class="n">TokenTensorizer</span><span class="p">(</span>
            <span class="n">text_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">doc_column</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span>
            <span class="n">max_seq_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_doc_seq_len</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ques_tensorizer</span> <span class="o">=</span> <span class="n">TokenTensorizer</span><span class="p">(</span>
            <span class="n">text_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ques_column</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span>
            <span class="n">max_seq_len</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">max_ques_seq_len</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">doc_tensorizer</span><span class="o">=</span><span class="n">doc_tensorizer</span><span class="p">,</span>
            <span class="n">ques_tensorizer</span><span class="o">=</span><span class="n">ques_tensorizer</span><span class="p">,</span>
            <span class="n">doc_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">doc_column</span><span class="p">,</span>
            <span class="n">ques_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">ques_column</span><span class="p">,</span>
            <span class="n">answers_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">answers_column</span><span class="p">,</span>
            <span class="n">answer_starts_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">answer_starts_column</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">vocab</span><span class="o">=</span><span class="n">vocab</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">doc_tensorizer</span><span class="p">:</span> <span class="n">TokenTensorizer</span><span class="p">,</span>
        <span class="n">ques_tensorizer</span><span class="p">:</span> <span class="n">TokenTensorizer</span><span class="p">,</span>
        <span class="n">doc_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">doc_column</span><span class="p">,</span>
        <span class="n">ques_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">ques_column</span><span class="p">,</span>
        <span class="n">answers_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">answers_column</span><span class="p">,</span>
        <span class="n">answer_starts_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">answer_starts_column</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">text_column</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ques_tensorizer</span> <span class="o">=</span> <span class="n">ques_tensorizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_tensorizer</span> <span class="o">=</span> <span class="n">doc_tensorizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc_column</span> <span class="o">=</span> <span class="n">doc_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ques_column</span> <span class="o">=</span> <span class="n">ques_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answers_column</span> <span class="o">=</span> <span class="n">answers_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answer_starts_column</span> <span class="o">=</span> <span class="n">answer_starts_column</span>

<div class="viewcode-block" id="SquadTensorizer.initialize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizer.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_builder</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">"""Build vocabulary based on training corpus."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">WordPieceTokenizer</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="ow">or</span> <span class="n">from_scratch</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span> <span class="o">=</span> <span class="n">vocab_builder</span> <span class="ow">or</span> <span class="n">VocabBuilder</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">pad_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">unk_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ques_initializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ques_tensorizer</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="p">,</span> <span class="n">from_scratch</span>
        <span class="p">)</span>
        <span class="n">doc_initializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_tensorizer</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="p">,</span> <span class="n">from_scratch</span>
        <span class="p">)</span>
        <span class="n">ques_initializer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">doc_initializer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">yield</span>
                <span class="n">ques_initializer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">doc_initializer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_builder</span><span class="o">.</span><span class="n">make_vocab</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_lookup_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">source_is_doc</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># This is useful in SquadMetricReporter._unnumberize()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc_tensorizer</span><span class="o">.</span><span class="n">_lookup_tokens</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source_is_doc</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ques_tensorizer</span><span class="o">.</span><span class="n">_lookup_tokens</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SquadTensorizer.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizer.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ques_tensorizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc_tensorizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>

        <span class="c1"># Do NOT use self._lookup_tokens() because it won't enforce max_ques_seq_len.</span>
        <span class="n">ques_tokens</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ques_tensorizer</span><span class="o">.</span><span class="n">_lookup_tokens</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ques_column</span><span class="p">])</span>

        <span class="c1"># Start and end indices are those of the tokens in original text.</span>
        <span class="c1"># The behavior doesn't change for WordPieceTokenizer because...</span>
        <span class="c1"># If there's a word piece, say, "##ly" then the start and end indices</span>
        <span class="c1"># will be that of "ly" in original text. These are also char level.</span>
        <span class="n">doc_tokens</span><span class="p">,</span> <span class="n">orig_start_idx</span><span class="p">,</span> <span class="n">orig_end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc_tensorizer</span><span class="o">.</span><span class="n">_lookup_tokens</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">doc_column</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Now map original character level answer spans to token level spans</span>
        <span class="n">start_idx_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">end_idx_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">token_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">orig_start_idx</span><span class="p">,</span> <span class="n">orig_end_idx</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">start_idx_map</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_idx</span>
            <span class="n">end_idx_map</span><span class="p">[</span><span class="n">end_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_idx</span>

        <span class="n">answer_start_token_indices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">start_idx_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">raw_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPAN_PAD_IDX</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">raw_idx</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_starts_column</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">answer_end_token_indices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">end_idx_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">raw_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPAN_PAD_IDX</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">raw_idx</span><span class="p">,</span> <span class="n">answer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_starts_column</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answers_column</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># The end index is inclusive. Span = doc_tokens[start:end+1]</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="p">(</span><span class="n">answer_start_token_indices</span> <span class="ow">and</span> <span class="n">answer_end_token_indices</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_pad</span><span class="p">(</span><span class="n">answer_start_token_indices</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_pad</span><span class="p">(</span><span class="n">answer_end_token_indices</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">answer_start_token_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SPAN_PAD_IDX</span><span class="p">]</span>
            <span class="n">answer_end_token_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">SPAN_PAD_IDX</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">doc_tokens</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">doc_tokens</span><span class="p">),</span>
            <span class="n">ques_tokens</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">ques_tokens</span><span class="p">),</span>
            <span class="n">answer_start_token_indices</span><span class="p">,</span>
            <span class="n">answer_end_token_indices</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SquadTensorizer.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizer.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">doc_tokens</span><span class="p">,</span>
            <span class="n">doc_seq_len</span><span class="p">,</span>
            <span class="n">ques_tokens</span><span class="p">,</span>
            <span class="n">ques_seq_len</span><span class="p">,</span>
            <span class="n">answer_start_idx</span><span class="p">,</span>
            <span class="n">answer_end_idx</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">doc_tokens</span> <span class="o">=</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">doc_tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">())</span>
        <span class="n">doc_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">doc_tokens</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">())</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span>  <span class="c1"># 1 =&gt; pad</span>
        <span class="n">ques_tokens</span> <span class="o">=</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">ques_tokens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">())</span>
        <span class="n">ques_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ques_tokens</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get_pad_index</span><span class="p">())</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span>  <span class="c1"># 1 =&gt; pad</span>
        <span class="n">answer_start_idx</span> <span class="o">=</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">answer_start_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPAN_PAD_IDX</span><span class="p">)</span>
        <span class="n">answer_end_idx</span> <span class="o">=</span> <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">answer_end_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPAN_PAD_IDX</span><span class="p">)</span>

        <span class="c1"># doc_tokens must be returned as the first element for</span>
        <span class="c1"># SquadMetricReporter._add_decoded_answer_batch_stats() to work</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">doc_tokens</span><span class="p">,</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">doc_seq_len</span><span class="p">),</span>
            <span class="n">doc_mask</span><span class="p">,</span>
            <span class="n">ques_tokens</span><span class="p">,</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">ques_seq_len</span><span class="p">),</span>
            <span class="n">ques_mask</span><span class="p">,</span>
            <span class="n">answer_start_idx</span><span class="p">,</span>
            <span class="n">answer_end_idx</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SquadTensorizer.sort_key"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizer.sort_key">[docs]</a>    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"SquadTensorizer.sort_key() should not be called."</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_only_pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token_id_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="n">token_id_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPAN_PAD_IDX</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div>


<div class="viewcode-block" id="SquadTensorizerForKD"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizerForKD">[docs]</a><span class="k">class</span> <span class="nc">SquadTensorizerForKD</span><span class="p">(</span><span class="n">SquadTensorizer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">SquadTensorizer</span><span class="o">.</span><span class="n">Config</span><span class="p">):</span>
        <span class="n">start_logits_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"start_logits"</span>
        <span class="n">end_logits_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"end_logits"</span>
        <span class="n">has_answer_logits_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"has_answer_logits"</span>
        <span class="n">pad_mask_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pad_mask"</span>
        <span class="n">segment_labels_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"segment_labels"</span>

<div class="viewcode-block" id="SquadTensorizerForKD.from_config"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizerForKD.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="n">start_logits_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">start_logits_column</span><span class="p">,</span>
            <span class="n">end_logits_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">end_logits_column</span><span class="p">,</span>
            <span class="n">has_answer_logits_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">has_answer_logits_column</span><span class="p">,</span>
            <span class="n">pad_mask_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">pad_mask_column</span><span class="p">,</span>
            <span class="n">segment_labels_column</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">segment_labels_column</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_logits_column</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">start_logits_column</span><span class="p">,</span>
        <span class="n">end_logits_column</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">end_logits_column</span><span class="p">,</span>
        <span class="n">has_answer_logits_column</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">has_answer_logits_column</span><span class="p">,</span>
        <span class="n">pad_mask_column</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">pad_mask_column</span><span class="p">,</span>
        <span class="n">segment_labels_column</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">segment_labels_column</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_logits_column</span> <span class="o">=</span> <span class="n">start_logits_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_logits_column</span> <span class="o">=</span> <span class="n">end_logits_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_answer_logits_column</span> <span class="o">=</span> <span class="n">has_answer_logits_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_mask_column</span> <span class="o">=</span> <span class="n">pad_mask_column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segment_labels_column</span> <span class="o">=</span> <span class="n">segment_labels_column</span>

<div class="viewcode-block" id="SquadTensorizerForKD.numberize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizerForKD.numberize">[docs]</a>    <span class="k">def</span> <span class="nf">numberize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">numberized_row_tuple</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">numberize</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">start_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_doc_logits</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">start_logits_column</span><span class="p">],</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_mask_column</span><span class="p">],</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_labels_column</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">end_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_doc_logits</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">end_logits_column</span><span class="p">],</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_mask_column</span><span class="p">],</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">segment_labels_column</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">numberized_row_tuple</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">start_logits</span><span class="p">,</span>
            <span class="n">end_logits</span><span class="p">,</span>
            <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">has_answer_logits_column</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SquadTensorizerForKD.tensorize"><a class="viewcode-back" href="../../../modules/pytext.data.html#pytext.data.squad_tensorizer.SquadTensorizerForKD.tensorize">[docs]</a>    <span class="k">def</span> <span class="nf">tensorize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="p">(</span>
            <span class="n">doc_tokens</span><span class="p">,</span>
            <span class="n">doc_seq_len</span><span class="p">,</span>
            <span class="n">ques_tokens</span><span class="p">,</span>
            <span class="n">ques_seq_len</span><span class="p">,</span>
            <span class="n">answer_start_idx</span><span class="p">,</span>
            <span class="n">answer_end_idx</span><span class="p">,</span>
            <span class="n">start_logits</span><span class="p">,</span>
            <span class="n">end_logits</span><span class="p">,</span>
            <span class="n">has_answer_logits</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">tensor_tuple</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">tensorize</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span>
                <span class="n">doc_tokens</span><span class="p">,</span>
                <span class="n">doc_seq_len</span><span class="p">,</span>
                <span class="n">ques_tokens</span><span class="p">,</span>
                <span class="n">ques_seq_len</span><span class="p">,</span>
                <span class="n">answer_start_idx</span><span class="p">,</span>
                <span class="n">answer_end_idx</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tensor_tuple</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">start_logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">end_logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
            <span class="n">pad_and_tensorize</span><span class="p">(</span><span class="n">has_answer_logits</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">),</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_doc_logits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">pad_mask</span><span class="p">,</span> <span class="n">segment_labels</span><span class="p">):</span>
        <span class="n">ques_seq_len</span> <span class="o">=</span> <span class="n">segment_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pad_start</span> <span class="o">=</span> <span class="n">pad_mask</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># 0 doesn't exits in pad_mask</span>
            <span class="n">pad_start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logits</span><span class="p">[</span><span class="n">ques_seq_len</span> <span class="p">:</span> <span class="n">pad_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Last non-pad token is [SEP]</span></div>
</pre></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">PyText</a></h1>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../train_your_first_model.html">Train your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../execute_your_first_model.html">Execute your first model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualize_your_model.html">Visualize Model Training with TensorBoard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pytext_models_in_your_app.html">Use PyText models in your app</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../serving_models_in_production.html">Serve Models in Production</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_files.html">Config Files Explained</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_commands.html">Config Commands</a></li>
</ul>
<p class="caption"><span class="caption-text">Training More Advanced Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../atis_tutorial.html">Train Intent-Slot model on ATIS Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hierarchical_intent_slot_tutorial.html">Hierarchical intent and slot filling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../disjoint_multitask_tutorial.html">Multitask training with disjoint datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed_training_tutorial.html">Data Parallel Distributed Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xlm_r.html">XLM-RoBERTa</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending PyText</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasource_tutorial.html">Custom Data Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorizer.html">Custom Tensorizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dense.html">Using External Dense Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../create_new_model.html">Creating A New Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hacking_pytext.html">Hacking PyText</a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../configs/pytext.html">pytext</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/pytext.html">pytext package</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
<li><a href="../../../index.html">Documentation overview</a><ul>
<li><a href="../../index.html">Module code</a><ul>
<li><a href="../../pytext.html">pytext</a><ul>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" name="q" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div></div>